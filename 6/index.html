<<!DOCTYPE html>
<html lang="en">
  <head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132824591-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132824591-1');
</script>

    <meta charset="utf-8"/>
    <title>Sergii Kostenko's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <!--link href="../css/prettify.css" rel="stylesheet"-->
    <link href="../css/prism.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <b><a class="navbar-brand" href="../index.html">Sergii Kostenko's Blog</a></b>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
										<li><a href="../tags/metrics.html">metrics</a></li>
										<li><a href="../tags/wildfly.html">wildfly</a></li>
										<li><a href="../tags/logging.html">logging</a></li>
										<li><a href="../tags/jakartaee.html">jakartaee</a></li>
										<li><a href="../tags/resin.html">resin</a></li>
										<li><a href="../tags/performance.html">performance</a></li>
										<li><a href="../tags/infinispan.html">infinispan</a></li>
										<li><a href="../tags/gradle.html">gradle</a></li>
										<li><a href="../tags/ide.html">ide</a></li>
										<li><a href="../tags/cdi.html">cdi</a></li>
										<li><a href="../tags/batch.html">batch</a></li>
										<li><a href="../tags/ci.html">ci</a></li>
										<li><a href="../tags/openapi.html">openapi</a></li>
										<li><a href="../tags/microprofile.html">microprofile</a></li>
										<li><a href="../tags/oracle.html">oracle</a></li>
										<li><a href="../tags/jberet.html">jberet</a></li>
										<li><a href="../tags/github.html">github</a></li>
										<li><a href="../tags/activemq.html">activemq</a></li>
										<li><a href="../tags/jetty.html">jetty</a></li>
										<li><a href="../tags/api.html">api</a></li>
										<li><a href="../tags/jcache.html">jcache</a></li>
										<li><a href="../tags/jpa.html">jpa</a></li>
										<li><a href="../tags/jenkins.html">jenkins</a></li>
										<li><a href="../tags/json-b.html">json-b</a></li>
										<li><a href="../tags/linux.html">linux</a></li>
										<li><a href="../tags/jmx.html">jmx</a></li>
										<li><a href="../tags/vaadin.html">vaadin</a></li>
										<li><a href="../tags/java.html">java</a></li>
										<li><a href="../tags/security.html">security</a></li>
										<li><a href="../tags/jms.html">jms</a></li>
										<li><a href="../tags/jaxb.html">jaxb</a></li>
										<li><a href="../tags/sql.html">sql</a></li>
										<li><a href="../tags/swagger.html">swagger</a></li>
										<li><a href="../tags/hibernate.html">hibernate</a></li>
										<li><a href="../tags/jdbc.html">jdbc</a></li>
										<li><a href="../tags/quarkus.html">quarkus</a></li>
										<li><a href="../tags/jwt.html">jwt</a></li>
										<li><a href="../tags/rest-client.html">rest-client</a></li>
										<li><a href="../tags/tomcat.html">tomcat</a></li>
										<li><a href="../tags/undertow.html">undertow</a></li>
										<li><a href="../tags/jax-rs.html">jax-rs</a></li>
										<li><a href="../tags/jsr532.html">jsr532</a></li>
										<li><a href="../tags/jbake.html">jbake</a></li>
								</ul>
						</li>
          </ul>
					<!-- switch language -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="/">en</a></li>
						<li><a href="/ru">ru</a></li>
						<li><a  class="icon-rss" href="../feed.xml"></a></li>
					</ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">


				<a href="https://kostenko.org/blog/2019/11/java-primitive-types-calculation.html"><h1>Never use Java primitives for math calculation</h1></a>
				<p>08 November 2019</p>
  			<p><p>This is well known stuff about representation of <a href="https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">Floating point types in java</a>, but time from time each developer can forget about</p>
<pre><code class="language-java">@Test
public void primitiveTest() {

    // right way:
    BigDecimal bgDcml = BigDecimal.valueOf(100000f).multiply(BigDecimal.valueOf(750f)).multiply(BigDecimal.valueOf(15f)).setScale(0);
    BigDecimal bgDcml2 = BigDecimal.valueOf(0.04d).multiply(BigDecimal.valueOf(15.0d));

    // wrong way:
    float flt = 100000f * 750f * 15f;
    float flt2 = 0.04f * 15.0f;

    System.out.println(&quot;BigDecimal (correct): &quot; + bgDcml);
    System.out.println(String.format(&quot;Float (incorrect): %s (%s)&quot;, flt, new BigDecimal(flt)));
    System.out.println(&quot;BigDecimal (correct): &quot; + bgDcml2);
    System.out.println(String.format(&quot;Float (incorrect): %s&quot;, flt2));
}
</code></pre>
<pre><code class="language-java">-------------------------------------------------------
 T E S T S
-------------------------------------------------------
BigDecimal (correct): 1125000000
Float (incorrect): 1.12499994E9 (1124999936)
BigDecimal (correct): 0.600
Float (incorrect): 0.59999996
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/11/java-primitive-types-calculation.html#disqus_thread" data-disqus-identifier="blog/2019/11/java-primitive-types-calculation.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/11/jakarta-batch-garbage-collection-jberet.html"><h1>Jakarta Batch garbage collection with Jberet</h1></a>
				<p>04 November 2019</p>
  			<p><p>To implement Jakarta Batch Specification Wildfly uses JBeret as implementation of JSR 352 (Batch Applications for the Java Platform). During processing, last one persists some working data to the memory, JDBC or another repository depends on configuration.</p>
<p>In case intensive usage it can collect lot of data and as result provoke some application server performance issues. To cleanup  <strong>unwanted job data</strong> you can design your own solution or use provided by Jberet <a href="https://docs.jboss.org/jberet/1.3.0.Final/javadoc/jberet-core/org/jberet/repository/PurgeBatchlet.html">org.jberet.repository.PurgeBatchlet</a> in standard way:</p>
<pre><code class="language-java">&lt;job id=&quot;batchGarbageCollector&quot; xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
     xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
     xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd&quot;
     version=&quot;1.0&quot;&gt;
    &lt;step id=&quot;batchGarbageCollector.step1&quot;&gt;
        &lt;batchlet ref=&quot;org.jberet.repository.PurgeBatchlet&quot;&gt;
            &lt;properties&gt;
                &lt;property name=&quot;sqlFile&quot; value=&quot;#{jobParameters['sqlFile']}&quot;/&gt;
            &lt;/properties&gt;
        &lt;/batchlet&gt;
    &lt;/step&gt;
&lt;/job&gt;
</code></pre>
<p>From the documentation <code>PurgeBatchlet</code> supports rich set of properties and looks pretty good, <strong>BUT</strong> on practice lot of them does not work as expected. I tried <code>numberOfRecentJobExecutionsToKeep</code> and <code>batchStatuses</code> on both WF repositories (inMemory and JDBC) and on both of them <strong>it does not work</strong> for me.</p>
<p>I am getting output like below, but garbage still was with me :(</p>
<pre><code class="language-java">...
INFO  [org.jberet] (Batch Thread - 8) [] JBERET000023: Removing javax.batch.runtime.JobExecution 35256804
INFO  [org.jberet] (Batch Thread - 8) [] JBERET000023: Removing javax.batch.runtime.JobExecution 35256806
...
</code></pre>
<p>Good news is, that in case using JDBC repository job parameter <code>sqlFile</code> works as expected and PurgeBatchlet executes provided SQL... without any log outputs.</p>
<p>Source code of test application available on <a href="https://github.com/kostenkoserg/ee-batch-processing-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/11/jakarta-batch-garbage-collection-jberet.html#disqus_thread" data-disqus-identifier="blog/2019/11/jakarta-batch-garbage-collection-jberet.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/10/migration-wildfly-10-to-18.html"><h1>Migration from Wildfly 10 to Wildfly 18</h1></a>
				<p>22 October 2019</p>
  			<p><p>Usually vendors declares easy migration, provides how-to documentation and even migration tools. But depends on complexity of your application you can stuck with some compatibility issues. Below i will explain my Wildfliy 10 to Wildfliy 18 migration steps.</p>
<p>First of all you can use provided by WF <a href="https://github.com/wildfly/wildfly-server-migration">migration tool</a> to migrate configuration files and compatible modules to the needed release:</p>
<pre><code class="language-java">git clone https://github.com/wildfly/wildfly-server-migration.git
cd ./wildfly-server-migration/
mvn clean install
cd ./dist/standalone/target/
unzip jboss-server-migration-1.8.0.Final-SNAPSHOT.zip
cd ./jboss-server-migration

./jboss-server-migration.sh -s /opt/wildfly-10.1.0.Final -t /opt/wildfly-18.0.0.Final/
</code></pre>
<p>Now let's see application level migration issues:</p>
<p>Issue #1:</p>
<pre><code class="language-java">Caused by: java.lang.IllegalArgumentException: org.hibernate.hql.internal.ast.QuerySyntaxException: Invalid path: 'org.kostenko.STATUS.ACTIVE'
</code></pre>
<p>Error above related to the Hibernate 5.2 <a href="https://vladmihalcea.com/the-performance-penalty-of-class-forname-when-parsing-jpql-and-criteria-queries/">performance improvement</a> that avoids unnecessary calls to Class.forName(). Solution here is <strong>using Java Naming conventions for a constant.</strong> (for example rename STATUS to Status) or in case  using non-conventional Java constants set the</p>
<pre><code class="language-java">&lt;property name=&quot;hibernate.query.conventional_java_constants&quot; value=&quot;false&quot;/&gt;
</code></pre>
<p>in your <strong>persistence.xml</strong></p>
<p>Issue #2:</p>
<pre><code class="language-java">java.lang.IllegalArgumentException: ArquillianServletRunner not found. Could not determine ContextRoot from ProtocolMetadata, please contact DeployableContainer developer.
</code></pre>
<p>In case using Arquillian you need just update version <code>org.wildfly.arquillian:wildfly-arquillian-container-managed</code> to version <code>2.2.0.Final</code></p>
<p>Issue #3:</p>
<pre><code class="language-java">org.jboss.weld.exceptions.UnsupportedOperationException:
  at org.jboss.weld.bean.proxy.CombinedInterceptorAndDecoratorStackMethodHandler.invoke(CombinedInterceptorAndDecoratorStackMethodHandler.java:49)
</code></pre>
<p>Seems to old <a href="https://issues.jboss.org/browse/WELD-2407">BUG</a> happened and Weld does not support Java 8 default methods completely. So, pity but same refactoring here is needed.</p>
<p>Issue #4:</p>
<pre><code class="language-java">WFLYRS0018: Explicit usage of Jackson annotation in a JAX-RS deployment; the system will disable JSON-B processing for the current deployment. Consider setting the 'resteasy.preferJacksonOverJsonB' property to 'false' to restore JSON-B.
...
javax.ws.rs.client.ResponseProcessingException: javax.ws.rs.ProcessingException: RESTEASY008200: JSON Binding deserialization error  
  at org.jboss.resteasy.client.jaxrs.internal.ClientInvocation.extractResult(ClientInvocation.java:156)  
  at org.jboss.resteasy.client.jaxrs.internal.ClientInvocation.invoke(ClientInvocation.java:473)  
  at org.jboss.resteasy.client.jaxrs.internal.ClientInvocationBuilder.get(ClientInvocationBuilder.java:195)  
</code></pre>
<p>Since latest versions, WF uses <code>org.eclipse.yasson</code> as <strong>JSON-B</strong> provider. It can provoke some compatibility problems in case using different  implementations. Solution here is refactoring according to the JSON-B specification or excluding <code>resteasy-json-binding-provider</code> from application class loader by providing <code>WEB-INF/jboss-deployment-structure.xml</code>:</p>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;jboss-deployment-structure&gt;
    &lt;deployment&gt;
        &lt;exclusions&gt;
            &lt;module name=&quot;org.jboss.resteasy.resteasy-json-binding-provider&quot;/&gt;
        &lt;/exclusions&gt;
    &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;
</code></pre>
<p>or in case using EARs, do exclusion from submodules like</p>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;jboss-deployment-structure&gt;
    &lt;deployment&gt;
        &lt;exclusions&gt;
            &lt;module name=&quot;org.jboss.resteasy.resteasy-json-binding-provider&quot;/&gt;
        &lt;/exclusions&gt;
    &lt;/deployment&gt;
    &lt;sub-deployment name=&quot;module-1.jar&quot;&gt;
        &lt;exclusions&gt;
            &lt;module name=&quot;org.jboss.resteasy.resteasy-json-binding-provider&quot;/&gt;
        &lt;/exclusions&gt;
    &lt;/sub-deployment&gt;    
&lt;/jboss-deployment-structure&gt;
</code></pre>
<p>Issue #5:<br />
According to the fixed Hibernate <a href="https://hibernate.atlassian.net/browse/HHH-11278">BUG</a>, for now JPA call <code>setMaxResult(0)</code> <strong>returns empty List</strong> instead of <strong>ALL</strong> elements in previous versions. So, just check it and do some refactoring if needed.</p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/10/migration-wildfly-10-to-18.html#disqus_thread" data-disqus-identifier="blog/2019/10/migration-wildfly-10-to-18.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/10/jax-rs-jersey-thread-leak.html"><h1>JAX-RS Client ThreadPool leak</h1></a>
				<p>04 October 2019</p>
  			<p><p>Recently got resource(ThreadPool\Thread) leak with JAX-RS Client implementation on WF10.0.1 (RestEasy).<br />
<img src="/img/2019-10-thraed-leak.png" alt="jax-rs thread leak" /></p>
<p>From the dump above we can see, that pool number is extremely height, the same time thread number is always 1. That means that some code uses <code>Executors.new*</code>, which returns <code>java.util.concurrent.ThreadPoolExecutor</code> using the DefaultThreadFactory.</p>
<p>Actually in this situation, it is <strong>ALL</strong> than we can see from thread and heap dumps when debugging leak like above. Because in case classes containing these executors was garbage collected, the executors get orphaned (but are still alive and uncollectable), making it difficult/impossible to detect from a heap dump where the executors came from.</p>
<p><strong>Lesson #1</strong> is: Doing <code>Executors.new*</code>, would be nice to little bit think about guys who will support your code and provide non default thread names with custom ThreadFactory like :)</p>
<pre><code class="language-java">ExecutorService es = Executors.newCachedThreadPool(new CustomThreadFactory());

...

class CustomThreadFactory implements ThreadFactory {

    @Override
    public Thread newThread(final Runnable r) {
        return new Thread(r, &quot;nice_place_for_helpful_name&quot;);
    }
}
</code></pre>
<p>So, after many times of investigation and &quot;heap walking&quot;(paths to GC root) i found few <code>Executors$DefaultThreadFactory</code> like</p>
<p><img src="/img/2019-10-thraed-leak-1.png" alt="jax-rs thread leak" /></p>
<p>what made me see the code with REST services invocations. Something like</p>
<pre><code class="language-java">public void doCall() {
    Client client = ClientBuilder.newClient();
    Future&lt;Response&gt; future = client.target(&quot;http://...&quot;)
                                 .request()
                                 .async().get();
}
</code></pre>
<p>According to WF10 JAX-RS implementation each <code>newClient()</code> will build ResteasyClient that uses <code>ExecutorService asyncInvocationExecutor</code> to do requests and potentially it is can be the reason of the leak.</p>
<p><strong>Lesson #2</strong> is: Always! do <code>close()</code> client after usage. Check that implementation closes connection and shutdowns ThreadPool in case errors (timeouts, socket resets, etc).</p>
<p><strong>Lesson #3</strong> is: Try to construct only a small number of Client instances in the application. Last one is still bit unclear from the pure JakartaEE application point of view, as it not works as well in  multi-threaded environment. (<code>Invalid use of BasicClientConnManager: connection still allocated. Make sure to release the connection before allocating another one.</code>)</p>
<p>P.S. Many thanks for JProfiler tool trial version to make me happy with ThreadDump walking.</p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/10/jax-rs-jersey-thread-leak.html#disqus_thread" data-disqus-identifier="blog/2019/10/jax-rs-jersey-thread-leak.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/09/jee-to-jakartaee-migration.html"><h1>Migration from JEE to JakartaEE</h1></a>
				<p>30 September 2019</p>
  			<p><p>As you probably know Java EE was moved from Oracle to the Eclipse Foundation where will evolve under the <strong>Jakarta EE</strong> brand.  Sept. 10, 2019 Jakarta EE Full Platform and Web Profile specifications was released by Eclipse Foundation during <a href="https://jakartaone.org/">JakartaOne Livestream</a>. Few days later Wildfly declared that <strong>WildFly 17.0.1</strong> has passed the Jakarta EE 8 TCK and certification request has been approved by the Jakarta EE Spec Committee. So, now WildFly is a Jakarta EE Full platform compatible implementation.</p>
<p>Let's do migration of typical <a href="https://kostenko.org/blog/2019/08/ee-application-multi-module-template.html">gradle EE project</a> to the Jakarta EE and look how hard is it. Current JakartaEE version <code>8.0.0</code> is fully compatible with JavaEE version <code>8.0</code>, that means no need to change project sources, just update dependency from <code>javax:javaee-api:8.0</code> to <code>jakarta.platform:jakarta.jakartaee-api:8.0.0</code></p>
<p><code>updated build.gradle:</code></p>
<pre><code class="language-java">apply plugin: 'war'
dependencies {
    providedCompile &quot;jakarta.platform:jakarta.jakartaee-api:8.0.0&quot;
}
</code></pre>
<p>That is it! Application builds and works well under WF17.0.1</p>
<p>Source code of demo application available on <a href="https://github.com/kostenkoserg/ee-application-multi-module-gradle-template">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/09/jee-to-jakartaee-migration.html#disqus_thread" data-disqus-identifier="blog/2019/09/jee-to-jakartaee-migration.html">Comments</a></p>
				<hr/>

		<ul class="pager">
				<li class="previous"><a href="https://kostenko.org/5">Previous</a></li>
			<li">Page: 6/12 (<a href="../archive.html">archive</a>)</li>
				<li class="next"><a href="https://kostenko.org/7">Next</a></li>
		</ul>
		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2019 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.6.4</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <!--script src="../js/prettify.js"></script-->
		<script src="../js/prism.js"></script>

		<script id="dsq-count-scr" src="//kostenko-org.disqus.com/count.js" async></script>
  </body>
</html>
