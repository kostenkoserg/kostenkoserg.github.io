<<!DOCTYPE html>
<html lang="en">
  <head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132824591-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132824591-1');
</script>

    <meta charset="utf-8"/>
    <title>Sergii Kostenko's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/asciidoctor.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <!--link href="css/prettify.css" rel="stylesheet"-->
    <link href="css/prism.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <b><a class="navbar-brand" href="index.html">Sergii Kostenko's Blog</a></b>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
										<li><a href="tags/Jetty.html">Jetty</a></li>
										<li><a href="tags/Performance.html">Performance</a></li>
										<li><a href="tags/Gradle.html">Gradle</a></li>
										<li><a href="tags/API.html">API</a></li>
										<li><a href="tags/JPA.html">JPA</a></li>
										<li><a href="tags/Jakarta.html">Jakarta</a></li>
										<li><a href="tags/JMX.html">JMX</a></li>
										<li><a href="tags/Jakarta EE.html">Jakarta EE</a></li>
										<li><a href="tags/Linux.html">Linux</a></li>
										<li><a href="tags/JBake.html">JBake</a></li>
										<li><a href="tags/JMS.html">JMS</a></li>
										<li><a href="tags/Jenkins.html">Jenkins</a></li>
										<li><a href="tags/Jberet.html">Jberet</a></li>
										<li><a href="tags/SQL.html">SQL</a></li>
										<li><a href="tags/CI.html">CI</a></li>
										<li><a href="tags/JakartaEE.html">JakartaEE</a></li>
										<li><a href="tags/Hibernate.html">Hibernate</a></li>
										<li><a href="tags/WildFly.html">WildFly</a></li>
										<li><a href="tags/Java.html">Java</a></li>
										<li><a href="tags/Batch.html">Batch</a></li>
										<li><a href="tags/JAX-RS.html">JAX-RS</a></li>
										<li><a href="tags/CDI.html">CDI</a></li>
										<li><a href="tags/GitHub.html">GitHub</a></li>
										<li><a href="tags/Wildfly.html">Wildfly</a></li>
										<li><a href="tags/Java EE.html">Java EE</a></li>
								</ul>
						</li>
          </ul>
					<!-- switch language -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="/">en</a></li>
						<li><a href="/ru">ru</a></li>
						<li><a  class="icon-rss" href="feed.xml"></a></li>
					</ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">


				<a href="https://kostenko.org/blog/2019/11/jakartaee-understanding-jms-transactions.html"><h1>Understanding JMS(MDB) transaction scopes in JakartaEE application</h1></a>
				<p>11 November 2019</p>
  			<p><p>Most useful way to deal with JMS in JakartaEE application is MDB(<strong>M</strong>essage <strong>D</strong>riven <strong>B</strong>eans). This type of bean acts as a JMS message listener to which messages can be delivered from either a queue or a topic.</p>
<p>Message Driven Bean supports only <code>Required</code> and <code>NotSupported</code> scopes as there is no incoming transaction context.</p>
<ul>
<li>
<p><strong>@Required:</strong> Transaction starts before read from queue (before onMessage). All next resource calls will use this transaction context. In case transaction rollback or some RuntimeException, - message will be roll back to destination. Container acknowledges delivery after TX commit;</p>
</li>
<li>
<p><strong>@NotSupported:</strong> No transaction started. Application server acknowledges delivery on successful onMessage(). In case RuntimeException, - message will be returned to destination;</p>
</li>
</ul>
<p>In both cases above, when message was returned to the destination, container will do redelivery according to application server configuration. For example on Wildfly it is: <code>max-delivery-attempts</code> and <code>redelivery-delay</code>.</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default/address-setting=#:read-attribute(name=max-delivery-attempts)
</code></pre>
<p>Be careful with redelivery configuration as in case <strong>&quot;poisen message&quot;</strong> it can negative affect performance of your application or even server.</p>
<p>When you use container-managed transactions, you can invoke next <code>MessageDrivenContext</code> methods:<br />
* setRollbackOnly: marks the current transaction to rollback.<br />
* getRollbackOnly: check current transaction has been marked for rollback or not.</p>
<p>In case bean-managed transactions you need to manually control transaction by <code>UserTransaction</code> methods and you also can set the activation configuration property acknowledgeMode to <code>Auto-acknowledge</code> or <code>Dups-ok-acknowledge</code> to specify how the message received by the message-driven bean to be acknowledged.</p>
<p>Ok. Let's pay attention on typical use cases and potentially issues with default configurations. Often enough MDB uses to do relatively long tasks that should be executed asynchronously. So typical message bean in this case will looks like:</p>
<pre><code class="language-java">@JMSDestinationDefinition(
        name = TxRequiredMessagerDrivenBean.TX_REQUIRED_QUEUE,
        interfaceName = &quot;javax.jms.Queue&quot;
)
@MessageDriven(activationConfig = {
    @ActivationConfigProperty(propertyName = &quot;destinationLookup&quot;, propertyValue = TxRequiredMessagerDrivenBean.TX_REQUIRED_QUEUE),
    @ActivationConfigProperty(propertyName = &quot;destinationType&quot;, propertyValue = &quot;javax.jms.Queue&quot;)
})
//@TransactionAttribute(TransactionAttributeType.REQUIRED)
public class TxRequiredMessagerDrivenBean implements MessageListener {

    public final static String TX_REQUIRED_QUEUE = &quot;java:global/jms/txRequiredQueue&quot;;

    @Resource
    MessageDrivenContext messageDrivenContext;

    @Override
    public void onMessage(Message msg) {
        System.out.println(&quot;Got new message.&quot;);
        try {
            System.out.println(&quot;Hello TxRequiredMessagerDrivenBean!&quot;);
            for (int x = 1; x &lt; 40; x++) {
                Thread.sleep(10_000l);
                System.out.println(&quot;Long transaction: &quot; + (10 * x) + &quot; sec.&quot;);
            }
        } catch (Exception ex) {
            System.err.println(ex);
            messageDrivenContext.setRollbackOnly();
        }
        System.out.println(&quot;Message  successfully processed&quot;);
    }
}
</code></pre>
<p>Now take a look to result of our bean invocation:</p>
<pre><code class="language-java">INFO  (Thread-1 (ActiveMQ-client-global-threads)) Got new message.
INFO  (Thread-1 (ActiveMQ-client-global-threads)) Hello TxRequiredMessagerDrivenBean!
INFO  (Thread-1 (ActiveMQ-client-global-threads)) Long transaction: 10 sec.
...
INFO  (Thread-1 (ActiveMQ-client-global-threads)) Long transaction: 290 sec.
...
WARN  [com.arjuna.ats.arjuna] (Transaction Reaper) ARJUNA012117: TransactionReaper::check timeout for TX 0:ffff7f000101:3b3ecbca:5dcc2894:13 in state  RUN
WARN  [com.arjuna.ats.arjuna] (Transaction Reaper Worker 0) ARJUNA012095: Abort of action id 0:ffff7f000101:3b3ecbca:5dcc2894:13 invoked while multiple threads active within it.
WARN  [com.arjuna.ats.arjuna] (Transaction Reaper Worker 0) ARJUNA012381: Action id 0:ffff7f000101:3b3ecbca:5dcc2894:13 completed with multiple threads - thread Thread-1 (ActiveMQ-client-global-threads) was in progress with java.lang.Thread.sleep(Native Method) org.kostenko.example.jms.transaction.TxRequiredMessagerDrivenBean.onMessage(TxRequiredMessagerDrivenBean.java:40)
...
WARN  [com.arjuna.ats.arjuna] (Transaction Reaper Worker 0) ARJUNA012108: CheckedAction::check - atomic action 0:ffff7f000101:3b3ecbca:5dcc2894:13 aborting with 1 threads active!
...
WARN  [com.arjuna.ats.arjuna] (Transaction Reaper Worker 0) ARJUNA012121: TransactionReaper::doCancellations worker Thread[Transaction Reaper Worker 0,5,main] successfully canceled TX 0:ffff7f000101:3b3ecbca:5dcc2894:13
...
INFO  (Thread-3 (ActiveMQ-client-global-threads)) Got new message.
INFO  (Thread-3 (ActiveMQ-client-global-threads)) Hello TxRequiredMessagerDrivenBean!
INFO  (Thread-1 (ActiveMQ-client-global-threads)) Long transaction: 300 sec.
INFO  (Thread-3 (ActiveMQ-client-global-threads)) Long transaction: 10 sec.
INFO  (Thread-1 (ActiveMQ-client-global-threads)) Long transaction: 310 sec.
INFO  (Thread-3 (ActiveMQ-client-global-threads)) Long transaction: 20 sec.
INFO  (Thread-1 (ActiveMQ-client-global-threads)) Long transaction: 320 sec.
...
INFO  (Thread-3 (ActiveMQ-client-global-threads)) [] Long transaction: 90 sec.
INFO  (Thread-1 (ActiveMQ-client-global-threads)) [] Long transaction: 390 sec.
INFO  (Thread-1 (ActiveMQ-client-global-threads)) [] Message  successfully processed
WARN  [com.arjuna.ats.arjuna] (Thread-1 (ActiveMQ-client-global-threads)) [] ARJUNA012077: Abort called on already aborted atomic action 0:ffff7f000101:3b3ecbca:5dcc2894:13
WARN  [org.apache.activemq.artemis.ra] (Thread-1 (ActiveMQ-client-global-threads)) [] AMQ152006: Unable to call after delivery: javax.resource.spi.LocalTransactionException: javax.transaction.RollbackException: ARJUNA016102: The transaction is not active! Uid is 0:ffff7f000101:3b3ecbca:5dcc2894:13
  Caused by: javax.transaction.RollbackException: ARJUNA016102: The transaction is not active! Uid is 0:ffff7f000101:3b3ecbca:5dcc2894:13
...
WARN  [org.apache.activemq.artemis.core.client] (Thread-1 (ActiveMQ-client-global-threads)) [] AMQ212009: resetting session after failure
</code></pre>
<p>From log above we can see that:</p>
<ul>
<li><code>TransactionAttributeType.REQUIRED</code> was used by default;</li>
<li>Started transaction was canceled by default timeout in <code>300 sec</code>;</li>
<li>Container detected TX cancellation - did message redelivery and MDB starts new transaction;</li>
<li>Old thread continue work with first message processing, but the transaction already is not active;</li>
</ul>
<p>So, keep this behavior in mind if you planning to play with long tasks and Message Driven Beans. Depends on requirements few <strong>solutions</strong> is possible here:</p>
<ul>
<li>Avoid long transaction usage. If last one is not necessary  always use <code>TransactionAttributeType.NOT_SUPPORTED</code></li>
<li>Increase default transaction timeout</li>
<li>Use an annotation @ActivationConfigProperty(propertyName=&quot;transactionTimeout&quot;, propertyValue=&quot;xxx&quot;) to specify custom transaction timeout for MDB like:</li>
</ul>
<pre><code class="language-java">@MessageDriven(activationConfig = {
    @ActivationConfigProperty(propertyName = &quot;destinationLookup&quot;, propertyValue = TxRequiredMessagerDrivenBean.TX_REQUIRED_QUEUE),
    @ActivationConfigProperty(propertyName = &quot;destinationType&quot;, propertyValue = &quot;javax.jms.Queue&quot;)
    @ActivationConfigProperty(propertyName = &quot;transactionTimeout&quot;, propertyValue=&quot;500&quot;)
})
</code></pre>
<p>Source code of test application available on <a href="https://github.com/kostenkoserg/ee-jms-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/11/jakartaee-understanding-jms-transactions.html#disqus_thread" data-disqus-identifier="blog/2019/11/jakartaee-understanding-jms-transactions.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/11/java-primitive-types-calculation.html"><h1>Never use Java primitives for math calculation</h1></a>
				<p>08 November 2019</p>
  			<p><p>This is well known stuff about representation of <a href="https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">Floating point types in java</a>, but time from time each developer can forget about</p>
<pre><code class="language-java">@Test
public void primitiveTest() {

    // right way:
    BigDecimal bgDcml = BigDecimal.valueOf(100000f).multiply(BigDecimal.valueOf(750f)).multiply(BigDecimal.valueOf(15f)).setScale(0);
    BigDecimal bgDcml2 = BigDecimal.valueOf(0.04d).multiply(BigDecimal.valueOf(15.0d));

    // wrong way:
    float flt = 100000f * 750f * 15f;
    float flt2 = 0.04f * 15.0f;

    System.out.println(&quot;BigDecimal (correct): &quot; + bgDcml);
    System.out.println(String.format(&quot;Float (incorrect): %s (%s)&quot;, flt, new BigDecimal(flt)));
    System.out.println(&quot;BigDecimal (correct): &quot; + bgDcml2);
    System.out.println(String.format(&quot;Float (incorrect): %s&quot;, flt2));
}
</code></pre>
<pre><code class="language-java">-------------------------------------------------------
 T E S T S
-------------------------------------------------------
BigDecimal (correct): 1125000000
Float (incorrect): 1.12499994E9 (1124999936)
BigDecimal (correct): 0.600
Float (incorrect): 0.59999996
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/11/java-primitive-types-calculation.html#disqus_thread" data-disqus-identifier="blog/2019/11/java-primitive-types-calculation.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/11/jakarta-batch-garbage-collection-jberet.html"><h1>Jakarta Batch garbage collection with Jberet</h1></a>
				<p>04 November 2019</p>
  			<p><p>To implement Jakarta Batch Specification Wildfly uses JBeret as implementation of JSR 352 (Batch Applications for the Java Platform). During processing, last one persists some working data to the memory, JDBC or another repository depends on configuration.</p>
<p>In case intensive usage it can collect lot of data and as result provoke some application server performance issues. To cleanup  <strong>unwanted job data</strong> you can design your own solution or use provided by Jberet <a href="https://docs.jboss.org/jberet/1.3.0.Final/javadoc/jberet-core/org/jberet/repository/PurgeBatchlet.html">org.jberet.repository.PurgeBatchlet</a> in standard way:</p>
<pre><code class="language-java">&lt;job id=&quot;batchGarbageCollector&quot; xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
     xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
     xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd&quot;
     version=&quot;1.0&quot;&gt;
    &lt;step id=&quot;batchGarbageCollector.step1&quot;&gt;
        &lt;batchlet ref=&quot;org.jberet.repository.PurgeBatchlet&quot;&gt;
            &lt;properties&gt;
                &lt;property name=&quot;sqlFile&quot; value=&quot;#{jobParameters['sqlFile']}&quot;/&gt;
            &lt;/properties&gt;
        &lt;/batchlet&gt;
    &lt;/step&gt;
&lt;/job&gt;
</code></pre>
<p>From the documentation <code>PurgeBatchlet</code> supports rich set of properties and looks pretty good, <strong>BUT</strong> on practice lot of them does not work as expected. I tried <code>numberOfRecentJobExecutionsToKeep</code> and <code>batchStatuses</code> on both WF repositories (inMemory and JDBC) and on both of them <strong>it does not work</strong> for me.</p>
<p>I am getting output like below, but garbage still was with me :(</p>
<pre><code class="language-java">...
INFO  [org.jberet] (Batch Thread - 8) [] JBERET000023: Removing javax.batch.runtime.JobExecution 35256804
INFO  [org.jberet] (Batch Thread - 8) [] JBERET000023: Removing javax.batch.runtime.JobExecution 35256806
...
</code></pre>
<p>Good news is, that in case using JDBC repository job parameter <code>sqlFile</code> works as expected and PurgeBatchlet executes provided SQL... without any log outputs.</p>
<p>Source code of test application available on <a href="https://github.com/kostenkoserg/ee-batch-processing-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/11/jakarta-batch-garbage-collection-jberet.html#disqus_thread" data-disqus-identifier="blog/2019/11/jakarta-batch-garbage-collection-jberet.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/10/migration-wildfly-10-to-18.html"><h1>Migration from Wildfly 10 to Wildfly 18</h1></a>
				<p>22 October 2019</p>
  			<p><p>Usually vendors declares easy migration, provides how-to documentation and even migration tools. But depends on complexity of your application you can stuck with some compatibility issues. Below i will explain my Wildfliy 10 to Wildfliy 18 migration steps.</p>
<p>First of all you can use provided by WF <a href="https://github.com/wildfly/wildfly-server-migration">migration tool</a> to migrate configuration files and compatible modules to the needed release:</p>
<pre><code class="language-java">git clone https://github.com/wildfly/wildfly-server-migration.git
cd ./wildfly-server-migration/
mvn clean install
cd ./dist/standalone/target/
unzip jboss-server-migration-1.8.0.Final-SNAPSHOT.zip
cd ./jboss-server-migration

./jboss-server-migration.sh -s /opt/wildfly-10.1.0.Final -t /opt/wildfly-18.0.0.Final/
</code></pre>
<p>Now let's see application level migration issues:</p>
<p>Issue #1:</p>
<pre><code class="language-java">Caused by: java.lang.IllegalArgumentException: org.hibernate.hql.internal.ast.QuerySyntaxException: Invalid path: 'org.kostenko.STATUS.ACTIVE'
</code></pre>
<p>Error above related to the Hibernate 5.2 <a href="https://vladmihalcea.com/the-performance-penalty-of-class-forname-when-parsing-jpql-and-criteria-queries/">performance improvement</a> that avoids unnecessary calls to Class.forName(). Solution here is <strong>using Java Naming conventions for a constant.</strong> (for example rename STATUS to Status) or in case  using non-conventional Java constants set the</p>
<pre><code class="language-java">&lt;property name=&quot;hibernate.query.conventional_java_constants&quot; value=&quot;false&quot;/&gt;
</code></pre>
<p>in your <strong>persistence.xml</strong></p>
<p>Issue #2:</p>
<pre><code class="language-java">java.lang.IllegalArgumentException: ArquillianServletRunner not found. Could not determine ContextRoot from ProtocolMetadata, please contact DeployableContainer developer.
</code></pre>
<p>In case using Arquillian you need just update version <code>org.wildfly.arquillian:wildfly-arquillian-container-managed</code> to version <code>2.2.0.Final</code></p>
<p>Issue #3:</p>
<pre><code class="language-java">org.jboss.weld.exceptions.UnsupportedOperationException:
  at org.jboss.weld.bean.proxy.CombinedInterceptorAndDecoratorStackMethodHandler.invoke(CombinedInterceptorAndDecoratorStackMethodHandler.java:49)
</code></pre>
<p>Seems to old <a href="https://issues.jboss.org/browse/WELD-2407">BUG</a> happened and Weld does not support Java 8 default methods completely. So, pity but same refactoring here is needed.</p>
<p>Issue #4:</p>
<pre><code class="language-java">WFLYRS0018: Explicit usage of Jackson annotation in a JAX-RS deployment; the system will disable JSON-B processing for the current deployment. Consider setting the 'resteasy.preferJacksonOverJsonB' property to 'false' to restore JSON-B.
...
javax.ws.rs.client.ResponseProcessingException: javax.ws.rs.ProcessingException: RESTEASY008200: JSON Binding deserialization error  
  at org.jboss.resteasy.client.jaxrs.internal.ClientInvocation.extractResult(ClientInvocation.java:156)  
  at org.jboss.resteasy.client.jaxrs.internal.ClientInvocation.invoke(ClientInvocation.java:473)  
  at org.jboss.resteasy.client.jaxrs.internal.ClientInvocationBuilder.get(ClientInvocationBuilder.java:195)  
</code></pre>
<p>Since latest versions, WF uses <code>org.eclipse.yasson</code> as <strong>JSON-B</strong> provider. It can provoke some compatibility problems in case using different  implementations. Solution here is refactoring according to the JSON-B specification or excluding <code>resteasy-json-binding-provider</code> from application class loader by providing <code>WEB-INF/jboss-deployment-structure.xml</code>:</p>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;jboss-deployment-structure&gt;
    &lt;deployment&gt;
        &lt;exclusions&gt;
            &lt;module name=&quot;org.jboss.resteasy.resteasy-json-binding-provider&quot;/&gt;
        &lt;/exclusions&gt;
    &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;
</code></pre>
<p>or in case using EARs, do exclusion from submodules like</p>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;jboss-deployment-structure&gt;
    &lt;deployment&gt;
        &lt;exclusions&gt;
            &lt;module name=&quot;org.jboss.resteasy.resteasy-json-binding-provider&quot;/&gt;
        &lt;/exclusions&gt;
    &lt;/deployment&gt;
    &lt;sub-deployment name=&quot;module-1.jar&quot;&gt;
        &lt;exclusions&gt;
            &lt;module name=&quot;org.jboss.resteasy.resteasy-json-binding-provider&quot;/&gt;
        &lt;/exclusions&gt;
    &lt;/sub-deployment&gt;    
&lt;/jboss-deployment-structure&gt;
</code></pre>
<p>Issue #5:<br />
According to the fixed Hibernate <a href="https://hibernate.atlassian.net/browse/HHH-11278">BUG</a>, for now JPA call <code>setMaxResult(0)</code> <strong>returns empty List</strong> instead of <strong>ALL</strong> elements in previous versions. So, just check it and do some refactoring if needed.</p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/10/migration-wildfly-10-to-18.html#disqus_thread" data-disqus-identifier="blog/2019/10/migration-wildfly-10-to-18.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/10/jax-rs-jersey-thread-leak.html"><h1>JAX-RS Client ThreadPool leak</h1></a>
				<p>04 October 2019</p>
  			<p><p>Recently got resource(ThreadPool\Thread) leak with JAX-RS Client implementation on WF10.0.1 (RestEasy).<br />
<img src="/img/2019-10-thraed-leak.png" alt="jax-rs thread leak" /></p>
<p>From the dump above we can see, that pool number is extremely height, the same time thread number is always 1. That means that some code uses <code>Executors.new*</code>, which returns <code>java.util.concurrent.ThreadPoolExecutor</code> using the DefaultThreadFactory.</p>
<p>Actually in this situation, it is <strong>ALL</strong> than we can see from thread and heap dumps when debugging leak like above. Because in case classes containing these executors was garbage collected, the executors get orphaned (but are still alive and uncollectable), making it difficult/impossible to detect from a heap dump where the executors came from.</p>
<p><strong>Lesson #1</strong> is: Doing <code>Executors.new*</code>, would be nice to little bit think about guys who will support your code and provide non default thread names with custom ThreadFactory like :)</p>
<pre><code class="language-java">ExecutorService es = Executors.newCachedThreadPool(new CustomThreadFactory());

...

class CustomThreadFactory implements ThreadFactory {

    @Override
    public Thread newThread(final Runnable r) {
        return new Thread(r, &quot;nice_place_for_helpful_name&quot;);
    }
}
</code></pre>
<p>So, after many times of investigation and &quot;heap walking&quot;(paths to GC root) i found few <code>Executors$DefaultThreadFactory</code> like</p>
<p><img src="/img/2019-10-thraed-leak-1.png" alt="jax-rs thread leak" /></p>
<p>what made me see the code with REST services invocations. Something like</p>
<pre><code class="language-java">public void doCall() {
    Client client = ClientBuilder.newClient();
    Future&lt;Response&gt; future = client.target(&quot;http://...&quot;)
                                 .request()
                                 .async().get();
}
</code></pre>
<p>According to WF10 JAX-RS implementation each <code>newClient()</code> will build ResteasyClient that uses <code>ExecutorService asyncInvocationExecutor</code> to do requests and potentially it is can be the reason of the leak.</p>
<p><strong>Lesson #2</strong> is: Always! do <code>close()</code> client after usage. Check that implementation closes connection and shutdowns ThreadPool in case errors (timeouts, socket resets, etc).</p>
<p><strong>Lesson #3</strong> is: Try to construct only a small number of Client instances in the application. Last one is still bit unclear from the pure JakartaEE application point of view, as it not works as well in  multi-threaded environment. (<code>Invalid use of BasicClientConnManager: connection still allocated. Make sure to release the connection before allocating another one.</code>)</p>
<p>P.S. Many thanks for JProfiler tool trial version to make me happy with ThreadDump walking.</p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/10/jax-rs-jersey-thread-leak.html#disqus_thread" data-disqus-identifier="blog/2019/10/jax-rs-jersey-thread-leak.html">Comments</a></p>
				<hr/>

		<ul class="pager">
			<li">Page: 1/7 (<a href="archive.html">archive</a>)</li>
				<li class="next"><a href="https://kostenko.org/2">Next</a></li>
		</ul>
		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2019 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.6.3</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!--script src="js/prettify.js"></script-->
		<script src="js/prism.js"></script>

		<script id="dsq-count-scr" src="//kostenko-org.disqus.com/count.js" async></script>
  </body>
</html>
