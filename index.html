<<!DOCTYPE html>
<html lang="en">
  <head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132824591-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132824591-1');
</script>

    <meta charset="utf-8"/>
    <title>Sergii Kostenko's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/asciidoctor.css" rel="stylesheet">
    <link href="css/base.css" rel="stylesheet">
    <!--link href="css/prettify.css" rel="stylesheet"-->
    <link href="css/prism.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <b><a class="navbar-brand" href="index.html">Sergii Kostenko's Blog</a></b>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
										<li><a href="tags/metrics.html">metrics</a></li>
										<li><a href="tags/wildfly.html">wildfly</a></li>
										<li><a href="tags/logging.html">logging</a></li>
										<li><a href="tags/jakartaee.html">jakartaee</a></li>
										<li><a href="tags/resin.html">resin</a></li>
										<li><a href="tags/performance.html">performance</a></li>
										<li><a href="tags/infinispan.html">infinispan</a></li>
										<li><a href="tags/gradle.html">gradle</a></li>
										<li><a href="tags/ide.html">ide</a></li>
										<li><a href="tags/cdi.html">cdi</a></li>
										<li><a href="tags/batch.html">batch</a></li>
										<li><a href="tags/ci.html">ci</a></li>
										<li><a href="tags/openapi.html">openapi</a></li>
										<li><a href="tags/microprofile.html">microprofile</a></li>
										<li><a href="tags/oracle.html">oracle</a></li>
										<li><a href="tags/jberet.html">jberet</a></li>
										<li><a href="tags/github.html">github</a></li>
										<li><a href="tags/activemq.html">activemq</a></li>
										<li><a href="tags/jetty.html">jetty</a></li>
										<li><a href="tags/api.html">api</a></li>
										<li><a href="tags/jcache.html">jcache</a></li>
										<li><a href="tags/jpa.html">jpa</a></li>
										<li><a href="tags/jenkins.html">jenkins</a></li>
										<li><a href="tags/json-b.html">json-b</a></li>
										<li><a href="tags/linux.html">linux</a></li>
										<li><a href="tags/jmx.html">jmx</a></li>
										<li><a href="tags/vaadin.html">vaadin</a></li>
										<li><a href="tags/java.html">java</a></li>
										<li><a href="tags/security.html">security</a></li>
										<li><a href="tags/jms.html">jms</a></li>
										<li><a href="tags/jaxb.html">jaxb</a></li>
										<li><a href="tags/sql.html">sql</a></li>
										<li><a href="tags/swagger.html">swagger</a></li>
										<li><a href="tags/hibernate.html">hibernate</a></li>
										<li><a href="tags/jdbc.html">jdbc</a></li>
										<li><a href="tags/quarkus.html">quarkus</a></li>
										<li><a href="tags/jwt.html">jwt</a></li>
										<li><a href="tags/rest-client.html">rest-client</a></li>
										<li><a href="tags/tomcat.html">tomcat</a></li>
										<li><a href="tags/undertow.html">undertow</a></li>
										<li><a href="tags/jax-rs.html">jax-rs</a></li>
										<li><a href="tags/jsr532.html">jsr532</a></li>
										<li><a href="tags/jbake.html">jbake</a></li>
								</ul>
						</li>
          </ul>
					<!-- switch language -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="/">en</a></li>
						<li><a href="/ru">ru</a></li>
						<li><a  class="icon-rss" href="feed.xml"></a></li>
					</ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">


				<a href="https://kostenko.org/blog/2021/undertow-ajp-balancer-.html"><h1>Undertow AJP balancer. UT005028: Proxy request failed: java.nio.BufferOverflowException</h1></a>
				<p>03 April 2021</p>
  			<p><p>Wildfly provides great out of the box <a href="https://kostenko.org/blog/2019/04/wildfly-cluster-domain-mode.html">load balancing support</a> by <strong>Undertow</strong> and <strong>modcluster</strong> subsystems<br />
Unfortunately, in case  HTTP headers size is huge enough (close to 16K),  which is so actual in JWT era - pity error happened:</p>
<pre><code class="language-java">ERROR [io.undertow.proxy] (default I/O-10) UT005028: Proxy request to /ee-jax-rs-examples/clusterdemo/serverinfo failed: java.io.IOException: java.nio.BufferOverflowException
 at io.undertow.server.handlers.proxy.ProxyHandler$HTTPTrailerChannelListener.handleEvent(ProxyHandler.java:771)
 at io.undertow.server.handlers.proxy.ProxyHandler$ProxyAction$1.completed(ProxyHandler.java:646)
 at io.undertow.server.handlers.proxy.ProxyHandler$ProxyAction$1.completed(ProxyHandler.java:561)
 at io.undertow.client.ajp.AjpClientExchange.invokeReadReadyCallback(AjpClientExchange.java:203)
 at io.undertow.client.ajp.AjpClientConnection.initiateRequest(AjpClientConnection.java:288)
 at io.undertow.client.ajp.AjpClientConnection.sendRequest(AjpClientConnection.java:242)
 at io.undertow.server.handlers.proxy.ProxyHandler$ProxyAction.run(ProxyHandler.java:561)
 at io.undertow.util.SameThreadExecutor.execute(SameThreadExecutor.java:35)
 at io.undertow.server.HttpServerExchange.dispatch(HttpServerExchange.java:815)
...
Caused by: java.nio.BufferOverflowException
 at java.nio.Buffer.nextPutIndex(Buffer.java:521)
 at java.nio.DirectByteBuffer.put(DirectByteBuffer.java:297)
 at io.undertow.protocols.ajp.AjpUtils.putString(AjpUtils.java:52)
 at io.undertow.protocols.ajp.AjpClientRequestClientStreamSinkChannel.createFrameHeaderImpl(AjpClientRequestClientStreamSinkChannel.java:176)
 at io.undertow.protocols.ajp.AjpClientRequestClientStreamSinkChannel.generateSendFrameHeader(AjpClientRequestClientStreamSinkChannel.java:290)
 at io.undertow.protocols.ajp.AjpClientFramePriority.insertFrame(AjpClientFramePriority.java:39)
 at io.undertow.protocols.ajp.AjpClientFramePriority.insertFrame(AjpClientFramePriority.java:32)
 at io.undertow.server.protocol.framed.AbstractFramedChannel.flushSenders(AbstractFramedChannel.java:603)
 at io.undertow.server.protocol.framed.AbstractFramedChannel.flush(AbstractFramedChannel.java:742)
 at io.undertow.server.protocol.framed.AbstractFramedChannel.queueFrame(AbstractFramedChannel.java:735)
 at io.undertow.server.protocol.framed.AbstractFramedStreamSinkChannel.queueFinalFrame(AbstractFramedStreamSinkChannel.java:267)
 at io.undertow.server.protocol.framed.AbstractFramedStreamSinkChannel.shutdownWrites(AbstractFramedStreamSinkChannel.java:244)
 at io.undertow.channels.DetachableStreamSinkChannel.shutdownWrites(DetachableStreamSinkChannel.java:79)
 at io.undertow.server.handlers.proxy.ProxyHandler$HTTPTrailerChannelListener.handleEvent(ProxyHandler.java:754)
</code></pre>
<p>The same request directly to backend server works well.  Tried to play with <strong>ajp-listener</strong> and <strong>mod-cluster</strong> filter <strong>&quot;max-*&quot;</strong> parameters, but have no luck.</p>
<p>Possible solution here is switch protocol from AJP to HTTP which can be bit less effective, but works well with big headers:</p>
<pre><code class="language-java">/profile=full-ha/subsystem=modcluster/proxy=default:write-attribute(name=listener, value=default)
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2021/undertow-ajp-balancer-.html#disqus_thread" data-disqus-identifier="blog/2021/undertow-ajp-balancer-.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2020/12/oracle-jdbc-defaultrowprefetch.html"><h1>Improve Oracle JDBC performance by fetch size tuning</h1></a>
				<p>28 December 2020</p>
  			<p><p>By default, when Oracle JDBC driver executes query, it retrieves a result set of <strong>10 rows</strong> at a time from the database cursor. Low fetch size value might cause more roundtrips to DB and this leads to a longer time to fetch results from queries. You can change the number of rows retrieved with each trip to the database cursor by changing the row fetch size value.</p>
<p><strong>Statement, PreparedStatement, CallableStatement</strong>, and <strong>ResultSet</strong> provides next methods for dealing with fetch size:</p>
<pre><code class="language-java">void setFetchSize(int rows) throws SQLException

int getFetchSize() throws SQLException
</code></pre>
<p>Default fetch size value  can be changed by <strong>defaultRowPrefetch</strong> connection property:</p>
<p>On Wildfly Application Server DataSource level by:</p>
<pre><code class="language-bash">[standalone@localhost:9990 /] /subsystem=datasources/data-source=ExampleOraDS/connection-properties=defaultRowPrefetch:add(value=1000)
</code></pre>
<p>On Hibernate level by  <strong><code>hibernate.jdbc.fetch_size</code></strong> property:</p>
<pre><code class="language-xml">&lt;properties&gt;
  ...
  &lt;property name=&quot;hibernate.jdbc.fetch_size&quot; value=&quot;1000&quot; /&gt;
  ...
&lt;/properties&gt;
</code></pre>
<p>I did simple test:</p>
<pre><code class="language-java">@Test
public void defaultRowPrefetchTest() throws Exception {
   EntityManager em = Persistence.createEntityManagerFactory(&quot;myDSTestOra&quot;).createEntityManager();

   Long time = System.currentTimeMillis();

   Query q = em.createNativeQuery(&quot;SELECT * FROM MY_TABLE&quot;, Tuple.class);
   List&lt;Tuple&gt; resultList = q.getResultList();

   System.out.println(System.currentTimeMillis() - time);
}
</code></pre>
<p>And on my laptop, fetching of <strong>16K</strong> records takes <strong>~185 ms</strong> with default value and <strong>~86 ms</strong> with <code>defaultRowPrefetch = 20000</code>. As you can see from the result - there is more than <strong>x2</strong> performance improvement.</p>
<p>Source code of test case on <a href="https://github.com/kostenkoserg/ee-jpa-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2020/12/oracle-jdbc-defaultrowprefetch.html#disqus_thread" data-disqus-identifier="blog/2020/12/oracle-jdbc-defaultrowprefetch.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2020/12/wildfly-microprofile-metrics.html"><h1>Microprofile metrics with Wildfly Application Server</h1></a>
				<p>27 December 2020</p>
  			<p><p>Any enterprise application can't be completely successful on production without good monitoring solution. For years vendors and developers provided custom tooling for it. Since <strong><a href="https://github.com/eclipse/microprofile-metrics">Eclipse Microprofile Metrics</a></strong> specification we have a unified way to export monitoring data to the management agents and  unified Java API, that developers can use to expose their telemetry data.</p>
<p>Wildfly application server provides  microprofile metrics support, but unfortunately <strong>only for standalone configurations</strong>  yet.  In case <strong>domain mode</strong> you can provide necessary dependencies</p>
<pre><code class="language-java">dependencies {
    compile group: 'org.eclipse.microprofile.metrics', name: 'microprofile-metrics-api', version: '2.3'
    compile group: 'io.smallrye', name: 'smallrye-metrics', version: '2.4.0'
}
</code></pre>
<p>and then expose application scope metrics through custom endpoint like</p>
<pre><code class="language-java">import io.smallrye.metrics.exporters.JsonExporter;
import io.smallrye.metrics.exporters.OpenMetricsExporter;
...
@Singleton
@Path(&quot;/metrics&quot;)
public class MetricsTestResource {

  private OpenMetricsExporter openMetricsExporter = new OpenMetricsExporter();
  private JsonExporter jsonExporter = new JsonExporter();

  @GET
  @Path(&quot;/prmths&quot;)
  public String prometheus() {
    return openMetricsExporter.exportAllScopes().toString();
  }

  @GET
  @Path(&quot;/json&quot;)
  public String json() {
    return jsonExporter.exportAllScopes().toString();
  }
</code></pre>
<p>JVM and subsystems metrics will not be available by endpoint above, but them  you can obtain through old good JMX.</p>
<p>Standalone server from the box provides metrics in  <strong>prometheus</strong> format for all scopes over management interface (port <strong>9990</strong> ) using <strong><code>org.wildfly.extension.microprofile.metrics-smallrye</code></strong> extension and <strong><code>microprofile-metrics-smallrye</code></strong> subsystem.</p>
<pre><code class="language-bash">kostenko@kostenko:$ curl http://127.0.0.1:9990/metrics/
# HELP base_classloader_loadedClasses_count Displays the number of classes that are currently loaded in the Java virtual machine.
# TYPE base_classloader_loadedClasses_count gauge
base_classloader_loadedClasses_count 11826.0
# HELP base_cpu_availableProcessors Displays the number of processors available to the Java virtual machine. This value may change during a particular invocation of the virtual machine.
# TYPE base_cpu_availableProcessors gauge
base_cpu_availableProcessors 8.0
...
</code></pre>
<p>For developers available next annotations (sorry for the low output examples values):</p>
<ul>
<li><strong>@Counted</strong> - counter, which counts the invocations of the annotated object.
<pre><code class="language-bash"># TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_total counter
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_total 1.0
</code></pre>
</li>
<li><strong>@ConcurrentGauge</strong> - gauge which counts the parallel invocations of the annotated object.
<pre><code class="language-bash"># TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_current gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_current 1.0
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_max gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_max 1.0
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_min gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_min 0.0
</code></pre>
</li>
<li><strong>@Gauge</strong> - gauge, which samples the value of the annotated object.
<pre><code class="language-bash"># TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_json gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_json 123.0
</code></pre>
</li>
<li><strong>@Metered</strong> - meter, which tracks the frequency of invocations of the annotated object.
<pre><code class="language-bash"># TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_total counter
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_total 6.0
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_rate_per_second 0.209682602430885
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_one_min_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_one_min_rate_per_second 0.015991117074135343
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_five_min_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_five_min_rate_per_second 0.0033057092356765017
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_fifteen_min_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_fifteen_min_rate_per_second 0.0011080303990206543
</code></pre>
</li>
<li><strong>@Metric</strong> - annotation that contains the metadata information when requesting a metric to be injected.
<pre><code class="language-bash"></code></pre>
</li>
<li><strong>@Timed</strong> - timer, which tracks duration of the annotated object.
<pre><code class="language-bash"># TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_rate_per_second 0.09811766798116955
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_one_min_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_one_min_rate_per_second 0.030703655021877174
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_five_min_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_five_min_rate_per_second 0.0065567799035988195
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_fifteen_min_rate_per_second gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_fifteen_min_rate_per_second 0.002209922141215539
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_min_seconds gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_min_seconds 5.88813E-4
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_max_seconds gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_max_seconds 0.005724684
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_mean_seconds gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_mean_seconds 0.0030220556126073638
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_stddev_seconds gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_stddev_seconds 0.0025644006235855748
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds summary
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds_count 2.0
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds{quantile=&quot;0.5&quot;} 5.88813E-4
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds{quantile=&quot;0.75&quot;} 0.005724684
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds{quantile=&quot;0.95&quot;} 0.005724684
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds{quantile=&quot;0.98&quot;} 0.005724684
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds{quantile=&quot;0.99&quot;} 0.005724684
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_seconds{quantile=&quot;0.999&quot;} 0.005724684
</code></pre>
</li>
<li><strong>@SimplyTimed</strong> - simple timer, which tracks duration and invocations of the annotated object.
<pre><code class="language-bash"># TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_total counter
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_total 1.0
# TYPE application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_elapsedTime_seconds gauge
application_org_kostenko_examples_microprofile_metrics_MetricsTestResource_prometheus_elapsedTime_seconds 0.005032859
</code></pre>
</li>
</ul>
<p><a href="https://prometheus.io/docs/introduction/overview/">Prometheus</a> is a free software application used for event monitoring and alerting. It records real-time metrics in a time series database (allowing for high dimensionality) built using a HTTP pull model, with flexible queries and real-time alerting.</p>
<p>Let's setup above and check how metrics monitoring with Prometheus looks on practice:</p>
<pre><code class="language-bash">wget https://github.com/prometheus/prometheus/releases/download/v2.23.0/prometheus-2.23.0.linux-amd64.tar.gz
tar xvfz prometheus-*.tar.gz
cd prometheus-*
</code></pre>
<p>To provide path to the metrics endpoint edit <strong><code>prometheus.yml</code></strong> and provide correct <strong>metrics_path</strong> and <strong>targets</strong></p>
<pre><code class="language-yaml"># Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
    - targets: ['127.0.0.1:9990']
</code></pre>
<p>This is it! <strong><code>http://localhost:9090/graph</code></strong> :<br />
<img src="/img/2020-12-wildfly-mp-metrics.png" alt="wildfly-microprofile-metrics" /></p>
<p>Now our metrics is collecting and can be visualized over standard prometheus UI(shown above) or easy integrated with <a href="https://prometheus.io/docs/visualization/grafana/">grafana</a></p>
<p>Source code of custom metrics endpoint example available on <a href="https://github.com/kostenkoserg/wildfly-microprofile-example">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2020/12/wildfly-microprofile-metrics.html#disqus_thread" data-disqus-identifier="blog/2020/12/wildfly-microprofile-metrics.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2020/11/infinispan-server-wildfly-integration.html"><h1>Infinispan Server as Wildfly remote cache container for your Jakarta EE application</h1></a>
				<p>29 November 2020</p>
  			<p><p><img src="/img/2020-11-wildfly-infinispan-server-1.png" alt="pager" /></p>
<p>Recently i wrote a few articles about <a href="https://kostenko.org/tags/infinispan.html">using infinispan cache</a> based on Wildfly infinispan subsystem. But even though Wildfly provides well cache containers management support, - from the high load and high availability points of view, make sense to take a look to separate clustered cache instances.</p>
<p><strong>PROS:</strong></p>
<ul>
<li>Heap, threads, GC pauses separated between application and cache containers.</li>
<li>Application or cache can be scaled separately depends on needs</li>
<li>More configuration possibilities (like ASYNC replication etc)</li>
<li>Minimizing affect of application to cache distribution and visa verse</li>
<li>Application containers restart keeps stored cache data</li>
</ul>
<p><strong>CONS:</strong></p>
<ul>
<li>Increase infrastructure complexity</li>
<li>Additional support and monitoring unit</li>
<li>Additional costs in case separate cache cloud nodes</li>
</ul>
<p>Fortunately, with Wildfly Application Server it easy enough to <strong>switch between embedded and remote cache containers</strong> even in runtime (just another JNDI lookup). So, let's try it out! And first, we need to download  stable <strong><a href="https://infinispan.org/download-archive/">infinispan server release</a></strong>. I have chosen <strong>10.1.8</strong> as my Wildfly 20 uses this one and  potential compatibility issues should be excluded.</p>
<p>After download, please extract distribution archive and run infinispan server</p>
<pre><code class="language-bash">kostenko@kostenko:/opt/infinispan-server-10.1.8.Final/bin$ ./server.sh
</code></pre>
<p>By default infinispan server will use port <strong>11222</strong> on <strong>127.0.0.1</strong>. To bind another IP just use <strong>-b</strong> binding parameter like <strong><code>-b 0.0.0.0</code></strong> on startup.</p>
<p>To create named cache you can use provided UI (<a href="http://127.0.0.1:11222/">http://127.0.0.1:11222/</a>) or cli console like</p>
<pre><code class="language-bash">/opt/iplatform/infinispan/bin/cli.sh
[disconnected]&gt; connect
create cache --template=org.infinispan.REPL_ASYNC myremotecache
</code></pre>
<p>Now let's perform Wildfly configuration to use remote cache container</p>
<pre><code class="language-bash">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=ispn1:add(host=127.0.0.1, port=11222)
batch
/subsystem=infinispan/remote-cache-container=myRemoteContainer:add(default-remote-cluster=data-grid-cluster)
/subsystem=infinispan/remote-cache-container=myRemoteContainer/remote-cluster=data-grid-cluster:add(socket-bindings=[ispn1])
run-batch
</code></pre>
<p>Actually, we just have finished with environment configuration and now we are ready for application development. As usual, <strong>Jakarta EE</strong>  <strong><code>build.gradle</code></strong> looks pretty laconical:</p>
<pre><code class="language-java">apply plugin: 'war'
dependencies {
    providedCompile &quot;jakarta.platform:jakarta.jakartaee-api:8.0.0&quot;
    providedCompile &quot;org.infinispan:infinispan-core:10.1.8.Final&quot;
    providedCompile &quot;org.infinispan:infinispan-client-hotrod:10.1.8.Final&quot;
}
</code></pre>
<p>To use configured cache container just inject registered <strong>@Resource</strong>:</p>
<pre><code class="language-java">@Named
public class TestCacheService {

    public static final String REMOTE_CACHE_NAME = &quot;myremotecache&quot;;

    @Resource(lookup = &quot;java:jboss/infinispan/remote-container/myRemoteContainer&quot;)
    org.infinispan.client.hotrod.RemoteCacheContainer remoteCacheContainer;

    public void putRemoteCache(String key, String value) {
        remoteCacheContainer.getCache(REMOTE_CACHE_NAME).put(key, String.format(&quot;%s (%s)&quot;, value, new Date()));
    }

    public Object getRemoteCache(String key) {
        return remoteCacheContainer.getCache(REMOTE_CACHE_NAME).get(key);
    }
}
</code></pre>
<p>Also, you can provide resource reference by <strong><code>WEB-INF/web.xml</code></strong> descriptor and use shorter resource lookup <strong>by name</strong> like <code>@Resource(name = &quot;myremotecontainer&quot;)</code></p>
<pre><code class="language-xml">&lt;resource-env-ref&gt;
    &lt;resource-env-ref-name&gt;myremotecontainer&lt;/resource-env-ref-name&gt;
    &lt;lookup-name&gt;java:jboss/infinispan/remote-container/myRemoteContainer&lt;/lookup-name&gt;
&lt;/resource-env-ref&gt;
</code></pre>
<p>Last thing we need, - is provide module dependencies by <strong><code>MANIFEST.MF</code></strong>:</p>
<pre><code class="language-java">Manifest-Version: 1.0
Dependencies: org.infinispan, org.infinispan.commons, org.infinispan.client.hotrod export
</code></pre>
<p>OR through <strong><code>jboss-deployment-structure.xml</code></strong> :</p>
<pre><code class="language-xml">&lt;jboss-deployment-structure&gt;
   &lt;deployment&gt;
      &lt;dependencies&gt;
         &lt;module name=&quot;org.infinispan&quot; export=&quot;TRUE&quot; /&gt;
         &lt;module name=&quot;org.infinispan.commons&quot; export=&quot;TRUE&quot; /&gt;
         &lt;module name=&quot;org.infinispan.client.hotrod&quot; export=&quot;TRUE&quot; /&gt;
      &lt;/dependencies&gt;
   &lt;/deployment&gt;
&lt;/jboss-deployment-structure&gt;
</code></pre>
<p>This is it! Build, deploy, and test it out.</p>
<pre><code class="language-bash">curl -o - &quot;http://localhost:8080/jcache-examples/jcache/ispn-remote-put?key=KEY1&amp;value=VALUE1&quot;
ok
curl -o - &quot;http://localhost:8080/jcache-examples/jcache/ispn-remote-get?key=KEY1&quot;
VALUE1 (Sat Nov 28 20:48:51 EET 2020)
</code></pre>
<p>To check remote cache container statistics you can use UI or  Infinispan <strong>CLI</strong> console:</p>
<pre><code class="language-bash">[disconnected]&gt; connect
cd caches
stats myremotecache
</code></pre>
<pre><code class="language-bash">{
  &quot;time_since_start&quot; : 23866,
  &quot;time_since_reset&quot; : 23866,
  &quot;current_number_of_entries&quot; : 1,
  &quot;current_number_of_entries_in_memory&quot; : 1,
  &quot;total_number_of_entries&quot; : 1,
  &quot;off_heap_memory_used&quot; : 0,
  ...
</code></pre>
<p>Last point i would like to pay attention is cache container <strong>height availability</strong> with <strong><code>Infinispan clustering</code></strong>.  By default, Infinispan uses MPING (multicast) protocol to cluster auto discovery. You can easy check it just by running another ISPN instances on some network. For example:</p>
<pre><code class="language-bash">$ cd &lt;ISPN_HOME&gt;
$ cp -r server server2
$ bin/server.sh -o 100 -s server2

$ bin/cli.sh
connect
describe
</code></pre>
<pre><code class="language-bash">{
  &quot;version&quot; : &quot;10.1.8.Final&quot;,
  ...
  &quot;cluster_members_physical_addresses&quot; : [ &quot;127.0.0.1:7800&quot;, &quot;127.0.0.1:7801&quot; ],
  &quot;cluster_size&quot; : 2,
  ...
}
</code></pre>
<p>Do not forget to add new ISPN node to your Wildfly configuration</p>
<pre><code class="language-bash">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=ispn2:add(host=127.0.0.1, port=11322)
/subsystem=infinispan/remote-cache-container=myRemoteContainer/remote-cluster=data-grid-cluster:write-attribute(name=socket-bindings, value=[ispn1,ispn2])
</code></pre>
<p>Please, notice if you perform cloud deployment or have some network restrictions, - auto discovery with <strong>MPING</strong> can be not accessible. In this case you can use a <strong>static list of IP addresses</strong>  by providing  <strong>TCPPING</strong> configuration via <strong><code>server/conf/infinispan.xml</code></strong>. Just add <code>jgroups</code> section and edit <code>transport</code> stack for default <code>cache-container</code> :</p>
<pre><code class="language-xml">&lt;infinispan&gt;

 &lt;jgroups&gt;
    &lt;stack name=&quot;mytcpping&quot;&gt;
      &lt;TCP bind_port=&quot;7800&quot; port_range=&quot;30&quot; recv_buf_size=&quot;20000000&quot; send_buf_size=&quot;640000&quot;/&gt;
      &lt;TCPPING   initial_hosts=&quot;${jgroups.tcpping.initial_hosts:127.0.0.1[7800],127.0.0.1[7800]}&quot;/&gt;
      &lt;MERGE3 /&gt;
      &lt;FD_SOCK /&gt;
      &lt;FD_ALL timeout=&quot;3000&quot; interval=&quot;1000&quot; timeout_check_interval=&quot;1000&quot; /&gt;
      &lt;VERIFY_SUSPECT timeout=&quot;1000&quot; /&gt;
      &lt;pbcast.NAKACK2 use_mcast_xmit=&quot;false&quot; xmit_interval=&quot;100&quot; xmit_table_num_rows=&quot;50&quot; xmit_table_msgs_per_row=&quot;1024&quot; xmit_table_max_compaction_time=&quot;30000&quot; /&gt;
      &lt;UNICAST3 xmit_interval=&quot;100&quot; xmit_table_num_rows=&quot;50&quot; xmit_table_msgs_per_row=&quot;1024&quot; xmit_table_max_compaction_time=&quot;30000&quot; /&gt;
      &lt;pbcast.STABLE stability_delay=&quot;200&quot; desired_avg_gossip=&quot;2000&quot; max_bytes=&quot;1M&quot; /&gt;
      &lt;pbcast.GMS print_local_addr=&quot;false&quot; join_timeout=&quot;${jgroups.join_timeout:2000}&quot; /&gt;
      &lt;UFC max_credits=&quot;4m&quot; min_threshold=&quot;0.40&quot; /&gt;
      &lt;MFC max_credits=&quot;4m&quot; min_threshold=&quot;0.40&quot; /&gt;
      &lt;FRAG3 /&gt;
    &lt;/stack&gt;
  &lt;/jgroups&gt;

   &lt;cache-container name=&quot;default&quot; statistics=&quot;true&quot;&gt;
     &lt;transport stack=&quot;mytcpping&quot; node-name=&quot;${infinispan.node.name:}&quot;/&gt;
   &lt;/cache-container&gt;
...
</code></pre>
<p>For more details about configuration, please refer to <a href="https://docs.wildfly.org/20/wildscribe/subsystem/infinispan/remote-cache-container/index.html">WildFly 20 Infinispan Model Reference</a> and <a href="https://infinispan.org/documentation/">Infinispan community documentation</a></p>
<p>Source code of described example available on <a href="https://github.com/kostenkoserg/wildfly-infinispan-example">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2020/11/infinispan-server-wildfly-integration.html#disqus_thread" data-disqus-identifier="blog/2020/11/infinispan-server-wildfly-integration.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2020/11/ora-01795-jpa-function-workaround.html"><h1>ORA-01795 and JPA function workaround</h1></a>
				<p>27 November 2020</p>
  			<p><p>Few posts ago i wrote about Hibernate Interceptor to solve <strong><a href="https://kostenko.org/blog/2020/10/jpa-ora-01795-hibernate-interceptor.html">ORA-01795: maximum number of expressions in a list is 1000 error</a></strong>. This way can be very helpful in case you got this limitation, but by some reasons not able to perform refactoring.</p>
<p>Another way to get it done with  <strong>JPQL</strong> is a <strong>JPA function()</strong>. We used similar approach to implement <a href="https://kostenko.org/blog/2020/10/jpa-count-over.html">JPA paging with COUNT(*) OVER()</a>.</p>
<p>So, let's see how less code we need to get it work with custom <em><code>Dialect</code></em>  workaround.</p>
<p><code>Custom dialect:</code></p>
<pre><code class="language-java">public class MyOraDialect extends Oracle10gDialect {
    public MyOraDialect () {
        super();
        // sql tuples workaround
        registerFunction( &quot;safeTupleIn&quot;, new VarArgsSQLFunction( StandardBasicTypes.INTEGER, &quot;(&quot;, &quot;,0),(&quot;, &quot;,0)&quot;));
        // custom SQLFunction workaround
        registerFunction( &quot;safeIn&quot;, new SafeInFunction());
    }
}
</code></pre>
<p><code>Usage example:</code></p>
<pre><code class="language-java">@Test
public void safeTupleIn1000Test() throws Exception {
     EntityManager em = Persistence.createEntityManagerFactory(&quot;myDSTestOra&quot;).createEntityManager();
     // this.generateTestData(em);
     ...
     Query query =  em.createQuery(&quot;SELECT b as post FROM OraBlogEntity b where (id, 0) in (function('safeTupleIn',:ids))&quot;, Tuple.class);
     query.setParameter(&quot;ids&quot;, idsList);
     List&lt;Tuple&gt; tpList = query.getResultList();
     System.out.println(tpList.size());
}
</code></pre>
<p>or bit cleaner:</p>
<pre><code class="language-java">...
Query query =  em.createQuery(&quot;SELECT b as post FROM OraBlogEntity b where id in (function('safeIn', id, :ids))&quot;, Tuple.class);
query.setParameter(&quot;ids&quot;, idsList);
...
</code></pre>
<p>Result SQL in this case SQL tuples will looks like</p>
<pre><code class="language-bash">Hibernate: select orablogent0_.id as id1_0_, orablogent0_.body as body2_0_, orablogent0_.title as title3_0_ from orablogentity orablogent0_ where (orablogent0_.id , 0) in ((?,0),(?,0),(?....)
</code></pre>
<p>In case custom SQLFunction implementation:</p>
<pre><code class="language-bash">Hibernate: select orablogent0_.id as id1_0_, orablogent0_.body as body2_0_, orablogent0_.title as title3_0_ from orablogentity orablogent0_ where orablogent0_.id in (?,...,?) or orablogent0_.id in (?,...,?)
</code></pre>
<p>Below is simple example how custom <strong><code>org.hibernate.dialect.function.SQLFunction</code></strong> can be implemented.</p>
<pre><code class="language-java">public class SafeInFunction implements SQLFunction {
    private final static int IN_CAUSE_LIMIT = 1000;
    ...
    @Override
    public String render(Type firstArgumentType, List arguments, SessionFactoryImplementor factory) throws QueryException {
        final StringBuilder buf = new StringBuilder();
        String fieldName = (String) arguments.get(0);
        for (int i = 1; i &lt; arguments.size(); i++) {
            if (i % IN_CAUSE_LIMIT == 0) {
                buf.deleteCharAt(buf.length() - 1).append(&quot;) or &quot;).append(fieldName).append(&quot; in (&quot;);
            }
            buf.append(&quot;?,&quot;);
        }
        return buf.deleteCharAt(buf.length() - 1).toString();
    }
}
</code></pre>
<p>PS. Hibernate provides <strong><code>org.hibernate.dialect.Dialect</code></strong> method to overwrite</p>
<pre><code class="language-java">/**
 * Return the limit that the underlying database places on the number of elements in an {@code IN} predicate.
 * If the database defines no such limits, simply return zero or less-than-zero.
 *
 * @return int The limit, or zero-or-less to indicate no limit.
 */
public int getInExpressionCountLimit() {
  return 0;
}
</code></pre>
<p>But unfortunately did not provides properly implementation yet and just throw warning</p>
<pre><code class="language-bash">WARN: HHH000443: Dialect limits the number of elements in an IN predicate to 1000 entries.  However, the given parameter list [ids] contained 1111 entries, which will likely cause failures to execute the query in the database
</code></pre>
<p>Source code of described example available on <a href="https://github.com/kostenkoserg/ee-jpa-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2020/11/ora-01795-jpa-function-workaround.html#disqus_thread" data-disqus-identifier="blog/2020/11/ora-01795-jpa-function-workaround.html">Comments</a></p>
				<hr/>

		<ul class="pager">
			<li">Page: 1/12 (<a href="archive.html">archive</a>)</li>
				<li class="next"><a href="https://kostenko.org/2">Next</a></li>
		</ul>
		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2019 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.6.4</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!--script src="js/prettify.js"></script-->
		<script src="js/prism.js"></script>

		<script id="dsq-count-scr" src="//kostenko-org.disqus.com/count.js" async></script>
  </body>
</html>
