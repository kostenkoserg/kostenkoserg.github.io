<<!DOCTYPE html>
<html lang="en">
  <head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132824591-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132824591-1');
</script>

    <meta charset="utf-8"/>
    <title>Sergii Kostenko's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <!--link href="../css/prettify.css" rel="stylesheet"-->
    <link href="../css/prism.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <b><a class="navbar-brand" href="../index.html">Sergii Kostenko's Blog</a></b>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
										<li><a href="../tags/wildfly.html">wildfly</a></li>
										<li><a href="../tags/logging.html">logging</a></li>
										<li><a href="../tags/jakartaee.html">jakartaee</a></li>
										<li><a href="../tags/resin.html">resin</a></li>
										<li><a href="../tags/performance.html">performance</a></li>
										<li><a href="../tags/infinispan.html">infinispan</a></li>
										<li><a href="../tags/gradle.html">gradle</a></li>
										<li><a href="../tags/ide.html">ide</a></li>
										<li><a href="../tags/cdi.html">cdi</a></li>
										<li><a href="../tags/batch.html">batch</a></li>
										<li><a href="../tags/ci.html">ci</a></li>
										<li><a href="../tags/openapi.html">openapi</a></li>
										<li><a href="../tags/microprofile.html">microprofile</a></li>
										<li><a href="../tags/jberet.html">jberet</a></li>
										<li><a href="../tags/github.html">github</a></li>
										<li><a href="../tags/activemq.html">activemq</a></li>
										<li><a href="../tags/jetty.html">jetty</a></li>
										<li><a href="../tags/api.html">api</a></li>
										<li><a href="../tags/jcache.html">jcache</a></li>
										<li><a href="../tags/jpa.html">jpa</a></li>
										<li><a href="../tags/jenkins.html">jenkins</a></li>
										<li><a href="../tags/json-b.html">json-b</a></li>
										<li><a href="../tags/linux.html">linux</a></li>
										<li><a href="../tags/jmx.html">jmx</a></li>
										<li><a href="../tags/vaadin.html">vaadin</a></li>
										<li><a href="../tags/java.html">java</a></li>
										<li><a href="../tags/security.html">security</a></li>
										<li><a href="../tags/jms.html">jms</a></li>
										<li><a href="../tags/jaxb.html">jaxb</a></li>
										<li><a href="../tags/sql.html">sql</a></li>
										<li><a href="../tags/swagger.html">swagger</a></li>
										<li><a href="../tags/hibernate.html">hibernate</a></li>
										<li><a href="../tags/quarkus.html">quarkus</a></li>
										<li><a href="../tags/jwt.html">jwt</a></li>
										<li><a href="../tags/rest-client.html">rest-client</a></li>
										<li><a href="../tags/tomcat.html">tomcat</a></li>
										<li><a href="../tags/jax-rs.html">jax-rs</a></li>
										<li><a href="../tags/jsr532.html">jsr532</a></li>
										<li><a href="../tags/jbake.html">jbake</a></li>
								</ul>
						</li>
          </ul>
					<!-- switch language -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="/">en</a></li>
						<li><a href="/ru">ru</a></li>
						<li><a  class="icon-rss" href="../feed.xml"></a></li>
					</ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">


				<a href="https://kostenko.org/blog/2019/07/wildfly-jms-duplicate-detection.html"><h1>JMS Duplicate Message Detection with Wildfly</h1></a>
				<p>19 July 2019</p>
  			<p><p>To support JMS specification Wildfly uses Apache ActiveMQ Artemis over active-mq subsystem. Last one provides mechanism to filtering out duplicate messages without application code changes.</p>
<p>To enable duplicate message detection you just need to set a special property on the message to a unique value</p>
<pre><code class="language-java">message.setStringProperty(&quot;_AMQ_DUPL_ID&quot;, uniqueId);
</code></pre>
<p>So, lets see how it works on practice and create simple Message Driven Bean to consume messages:</p>
<pre><code class="language-java">@JMSDestinationDefinition(
        name = DuplicateJMSTestBean.DUPLICATE_QUEUE,
        interfaceName = &quot;javax.jms.Queue&quot;
)
@MessageDriven(activationConfig = {
    @ActivationConfigProperty(propertyName = &quot;destinationLookup&quot;, propertyValue = DuplicateJMSTestBean.DUPLICATE_QUEUE),
    @ActivationConfigProperty(propertyName = &quot;destinationType&quot;, propertyValue = &quot;javax.jms.Queue&quot;)
})
@TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)
public class DuplicateJMSTestBean implements MessageListener {

    public final static String DUPLICATE_QUEUE = &quot;java:global/jms/duplicateTestQueue&quot;;

    @Override
    public void onMessage(Message msg) {
        System.out.println(&quot;Got new message.&quot;);
        MessageStorage.messages.add(msg);
        try {
            Thread.sleep(5_000l);
        } catch(Exception ignore) {}
        System.out.println(&quot;Message  successfully processed&quot;);
    }
}
</code></pre>
<p>And simple JAX-RS endpoint to produce messages</p>
<pre><code class="language-java">@Path(&quot;/&quot;)
@Stateless
@TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)
public class DuplicateTestEndpoint {

    @Inject
    private JMSContext context;
    @Resource(lookup = DuplicateJMSTestBean.DUPLICATE_QUEUE)
    private Queue queue;

    @GET
    @Path(&quot;/sendmessage&quot;)
    public Response sendMessage(@QueryParam(&quot;duplicate-id&quot;) String duplicateId) {
        try {
            ObjectMessage message = context.createObjectMessage();
            if (duplicateId == null) {
                context.createProducer().send(queue, message);
            } else {
                message.setStringProperty(&quot;_AMQ_DUPL_ID&quot;, duplicateId);
                context.createProducer().send(queue, message);
            }
            return Response.ok().entity(&quot;Message was sent.  Recieved &quot; + MessageStorage.messages.size() + &quot; messagges: &quot; + MessageStorage.messages).build();
        } catch (Throwable e) {
            return Response.ok().entity(&quot;Error: &quot; + e).build();
        }
    }
}
</code></pre>
<p>Now in case we send message with the same <code>_AMQ_DUPL_ID</code> without transaction by <code>http://127.0.0.1:8080/jms-examples/sendmessage?duplicate-id=myuniqueid</code> we will get in logs:</p>
<pre><code class="language-java">WARN [org.apache.activemq.artemis.core.server] (Thread-448 (ActiveMQ-server-org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl$5@e47887a)) AMQ222059: Duplicate message detected - message will not be routed. Message information:
CoreMessage[messageID=1505,durable=true,userID=3d27afde-a9fa-11e9-af5d-0242e352ec80,priority=4, timestamp=Fri Jul 19 10:53:04 EEST 2019,expiration=0, durable=true, address=jms.queue.jms-examples_jms-examples_jms-examples_java:global/jms/duplicateTestQueue,size=416,properties=TypedProperties[__AMQ_CID=38587489-a9fa-11e9-af5d-0242e352ec80,_AMQ_DUPL_ID=myuniqueid,_AMQ_ROUTING_TYPE=1]]@145077408
</code></pre>
<p>and message will NOT consume by consumer. In case you send message in transaction - you will get <code>Exception</code> on commit.</p>
<p>Keep in mind, that to store IDs activemq uses circular fixed size cache</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default:read-attribute(name=id-cache-size)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; 20000
}
</code></pre>
<p>so, this value should be big enough to avoid rewriting. Also, you can configure persist cache or not (by default: <code>true</code>)</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default:write-attribute(name=persist-id-cache,value=false)
</code></pre>
<p>Source code available on <a href="https://github.com/kostenkoserg/ee-jms-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/07/wildfly-jms-duplicate-detection.html#disqus_thread" data-disqus-identifier="blog/2019/07/wildfly-jms-duplicate-detection.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/07/jenkins-nice-to-have-plugins.html"><h1>Jenkins. Nice to have plugins</h1></a>
				<p>05 July 2019</p>
  			<p><p>Jenkins is leading open source automation tool that provides lot of plugins to make your CI better. Below is few of them that, on my opinion, can be helpful for any project.</p>
<blockquote>
<p><strong>1. <a href="https://plugins.jenkins.io/build-monitor-plugin">Build Monitor Plugin</a></strong> - provides a highly visible view of the status of selected Jenkins jobs;</p>
</blockquote>
<p><img src="/img/2019-07-jenkins-build-monitor-plugin.png" alt="Build Monitor Plugin" /></p>
<blockquote>
<p><strong>2. <a href="https://plugins.jenkins.io/git-parameter">Git Parameter Plugin</a></strong> - adds ability to choose branches, tags or revisions from git repository configured in project;</p>
</blockquote>
<p><img src="/img/2019-07-jenkins-git-parameter-plugin.png" alt="Git Parameter Plugin" /></p>
<blockquote>
<p><strong>3. <a href="https://plugins.jenkins.io/htmlpublisher">HTML Publisher Plugin</a></strong> - publish the html reports that your build generates to the job and build pages;</p>
</blockquote>
<p><img src="/img/2019-07-jenkins-html-report-plugin.png" alt="Git Parameter Plugin" /></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/07/jenkins-nice-to-have-plugins.html#disqus_thread" data-disqus-identifier="blog/2019/07/jenkins-nice-to-have-plugins.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/06/wildfly-activemq-deadlock.html"><h1>Wildfly active-mq subsystem deadlock</h1></a>
				<p>29 June 2019</p>
  			<p><p>Recently got unusual height CPU utilizaton on random wildly cluster instance. Thread dump shows the reason of a problem:</p>
<pre><code class="language-java">Found one Java-level deadlock:
=============================

&quot;Thread-1 (ActiveMQ-server-org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl$2@46fcd20a-1114701218)&quot;:
  waiting to lock Monitor@0x00007f45f02e20f8 (Object@0x0000000603407950, a org/apache/activemq/artemis/core/server/cluster/impl/ClusterConnectionImpl$MessageFlowRecordImpl),
  which is held by &quot;Thread-29 (ActiveMQ-client-global-threads-2129186403)&quot;
&quot;Thread-29 (ActiveMQ-client-global-threads-2129186403)&quot;:
  waiting to lock Monitor@0x00007f46203b5518 (Object@0x00000004cc79a7b8, a org/apache/activemq/artemis/core/server/impl/QueueImpl),
  which is held by &quot;Thread-1 (ActiveMQ-server-org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl$2@46fcd20a-1114701218)&quot;

Found a total of 1 deadlock.
</code></pre>
<p>Below is part of official documentation:</p>
<blockquote>
<p>&quot;If thread-pool-max-size is set to a positive integer greater than zero, the thread pool is bounded. If requests come in and there are no free threads available in the pool, requests will block until a thread becomes available. It is recommended that a bounded thread pool be used with caution since it can lead to <strong>deadlock situations</strong> if the upper bound is configured too low.&quot;</p>
</blockquote>
<p>So, solution is:</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default:write-attribute(name=thread-pool-max-size,value=-1)
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/06/wildfly-activemq-deadlock.html#disqus_thread" data-disqus-identifier="blog/2019/06/wildfly-activemq-deadlock.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/06/runtime-class-loading.html"><h1>How to use custom ClassLoader to load jars in runtime</h1></a>
				<p>28 June 2019</p>
  			<p><p>To load calsses in runtime java uses ClassLoader mechanism which is based on next core principles:</p>
<ul>
<li><strong>delegation</strong> - by default uses <code>parent-first delegation</code>, - child ClassLoader will be used if parent is not able to find or load class. This behavior can be changed to <code>child-first</code> by overwriting <code>ClassLoader.loadClass(...)</code>;</li>
<li><strong>visibility</strong> - child ClassLoader is able to see all the classes loaded by parent but vice-versa is not true;</li>
<li><strong>uniqueness</strong> - allows to load a class exactly once, which is basically achieved by delegation and ensures that child ClassLoader doesn't reload the class already loaded by parent;</li>
</ul>
<p>The main scenarios to use custom ClassLoader is:</p>
<ul>
<li><strong>Class Instrumentation</strong> - modifying classes at runtime. For example, to unit testing, debugging or monitoring;</li>
<li><strong>Isolation of executions</strong> - isolate several execution environments within a single process by making visible only a subset of classes for a particular thread, like it does in EE environments;</li>
</ul>
<p>So, let's see how using of custom ClassLoader looks from source code perspective:</p>
<pre><code class="language-java">List&lt;File&gt; jars = Arrays.asList(new File(&quot;/tmp/jars&quot;).listFiles());
URL[] urls = new URL[files.size()];
for (int i = 0; i &lt; jars.size(); i++) {
    try {
        urls[i] = jars.get(i).toURI().toURL();
    } catch (Exception e) {
        e.printStackTrace();
    }
}
URLClassLoader childClassLoader = new URLClassLoader(urls, ClassLoader.getSystemClassLoader());
</code></pre>
<p>Then load class with custom ClassLoader:</p>
<pre><code class="language-java">Class.forName(&quot;org.kostenko.examples.core.classloader.ClassLoaderTest&quot;, true , childClassLoader);
</code></pre>
<p>Note! If your loaded libraries uses some resources like properties or something else, you need to provide context class loader:</p>
<pre><code class="language-java">Thread.currentThread().setContextClassLoader(childClassLoader);  
</code></pre>
<p>Also, you can use custom ClassLoaders to load services with Java Service Provider Interface(SPI)</p>
<pre><code class="language-java">ServiceLoader&lt;MyProvider&gt; serviceLoader = ServiceLoader.load(MyProvider.class, childClassLoader);
...
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/06/runtime-class-loading.html#disqus_thread" data-disqus-identifier="blog/2019/06/runtime-class-loading.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/05/design-dsl-api-java.html"><h1>Design DSL API in Java</h1></a>
				<p>27 May 2019</p>
  			<p><p>Well designed API is very important in case you expect your API will use someone else instead of just you. To build readable and writable DSL(domain specific language) in Java usually uses Builder pattern with few simple rules:</p>
<ul>
<li>Think twice about names for methods</li>
<li>Restrict available values for each step</li>
</ul>
<p>So, lets see how it looks from source code perspective...</p>
<p>Design API entry point</p>
<pre><code class="language-java">public class MyAPI {
    public static UserBuilder.Registration asUser() {
        return new UserBuilder.User();
    }
}
</code></pre>
<p>Design builder using interfaces to restrict available values depends on current step</p>
<pre><code class="language-java">public class UserBuilder {
    public static class User implements Registration, Login, Password, Apply {
        private String login;
        private String password;

        @Override
        public Login doRegistration() {
            return this;
        }
        @Override
        public Password withLogin(String login) {
            this.login = login;
            return this;
        }
        @Override
        public Apply withPassword(String password) {
            this.password = password;
            return this;
        }
        @Override
        public void apply() {
            // ...
        }
    }

    public interface Registration {
        Login doRegistration();
    }
    public interface Login {
        Password withLogin(String login);
    }
    public interface Password {
        Apply withPassword(String password);
    }
    public interface Apply {
        void apply();
    }
}
</code></pre>
<p>Then usage, with no chance to mistake, looks like</p>
<pre><code class="language-java">asUser().doRegistration()
        .withLogin(&quot;login&quot;).withPassword(&quot;password&quot;)
        .apply();
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/05/design-dsl-api-java.html#disqus_thread" data-disqus-identifier="blog/2019/05/design-dsl-api-java.html">Comments</a></p>
				<hr/>

		<ul class="pager">
				<li class="previous"><a href="https://kostenko.org/6">Previous</a></li>
			<li">Page: 7/10 (<a href="../archive.html">archive</a>)</li>
				<li class="next"><a href="https://kostenko.org/8">Next</a></li>
		</ul>
		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2019 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.6.4</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <!--script src="../js/prettify.js"></script-->
		<script src="../js/prism.js"></script>

		<script id="dsq-count-scr" src="//kostenko-org.disqus.com/count.js" async></script>
  </body>
</html>
