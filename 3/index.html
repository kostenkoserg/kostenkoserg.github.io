<<!DOCTYPE html>
<html lang="en">
  <head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132824591-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132824591-1');
</script>

    <meta charset="utf-8"/>
    <title>Sergii Kostenko's blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <!--link href="../css/prettify.css" rel="stylesheet"-->
    <link href="../css/prism.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <b><a class="navbar-brand" href="../index.html">Sergii Kostenko's Blog</a></b>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
										<li><a href="../tags/Jetty.html">Jetty</a></li>
										<li><a href="../tags/Performance.html">Performance</a></li>
										<li><a href="../tags/Gradle.html">Gradle</a></li>
										<li><a href="../tags/API.html">API</a></li>
										<li><a href="../tags/JPA.html">JPA</a></li>
										<li><a href="../tags/Jakarta.html">Jakarta</a></li>
										<li><a href="../tags/JMX.html">JMX</a></li>
										<li><a href="../tags/Jakarta EE.html">Jakarta EE</a></li>
										<li><a href="../tags/Linux.html">Linux</a></li>
										<li><a href="../tags/JBake.html">JBake</a></li>
										<li><a href="../tags/JMS.html">JMS</a></li>
										<li><a href="../tags/Jenkins.html">Jenkins</a></li>
										<li><a href="../tags/Jberet.html">Jberet</a></li>
										<li><a href="../tags/SQL.html">SQL</a></li>
										<li><a href="../tags/CI.html">CI</a></li>
										<li><a href="../tags/JakartaEE.html">JakartaEE</a></li>
										<li><a href="../tags/Hibernate.html">Hibernate</a></li>
										<li><a href="../tags/WildFly.html">WildFly</a></li>
										<li><a href="../tags/Java.html">Java</a></li>
										<li><a href="../tags/Batch.html">Batch</a></li>
										<li><a href="../tags/JAX-RS.html">JAX-RS</a></li>
										<li><a href="../tags/CDI.html">CDI</a></li>
										<li><a href="../tags/GitHub.html">GitHub</a></li>
										<li><a href="../tags/Wildfly.html">Wildfly</a></li>
										<li><a href="../tags/Java EE.html">Java EE</a></li>
								</ul>
						</li>
          </ul>
					<!-- switch language -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="/">en</a></li>
						<li><a href="/ru">ru</a></li>
						<li><a  class="icon-rss" href="../feed.xml"></a></li>
					</ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">


				<a href="https://kostenko.org/blog/2019/08/WFLYEJB0054.html"><h1>WFLYEJB0054: Failed to marshal EJB parameters</h1></a>
				<p>05 August 2019</p>
  			<p><p>Usually error <code>WFLYEJB0054: Failed to marshal EJB parameters</code> can be throw by next reason:</p>
<ul>
<li>Your data transfer object does not implement Serializable</li>
<li>Your transfered object does not exist in destination module classpath (for example, if you are using DTO without strong typing)</li>
</ul>
<p>Also, you can catch this error with absolutely unexpected scenario and unclear stacktrace when your EJB throws some unchecked exception with stacktrace that has objects from points above.</p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/08/WFLYEJB0054.html#disqus_thread" data-disqus-identifier="blog/2019/08/WFLYEJB0054.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/07/sql-trick-insert-if-noe-exists.html"><h1>SQL trick. Insert if not exists</h1></a>
				<p>24 July 2019</p>
  			<p><p>Next SQL trick allows you perform conditional <code>INSERT</code> with your query.</p>
<p>For example, lets do insert if record not exists yet:</p>
<p>SQL:</p>
<pre><code class="language-sql">INSERT INTO my_table (id, name)  
    SELECT 1, 'name' FROM dual  WHERE NOT EXISTS (SELECT 1 FROM my_table WHERE ID = 1);
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/07/sql-trick-insert-if-noe-exists.html#disqus_thread" data-disqus-identifier="blog/2019/07/sql-trick-insert-if-noe-exists.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/07/wildfly-jms-duplicate-detection.html"><h1>JMS Duplicate Message Detection with Wildfly</h1></a>
				<p>19 July 2019</p>
  			<p><p>To support JMS specification Wildfly uses Apache ActiveMQ Artemis over active-mq subsystem. Last one provides mechanism to filtering out duplicate messages without application code changes.</p>
<p>To enable duplicate message detection you just need to set a special property on the message to a unique value</p>
<pre><code class="language-java">message.setStringProperty(&quot;_AMQ_DUPL_ID&quot;, uniqueId);
</code></pre>
<p>So, lets see how it works on practice and create simple Message Driven Bean to consume messages:</p>
<pre><code class="language-java">@JMSDestinationDefinition(
        name = DuplicateJMSTestBean.DUPLICATE_QUEUE,
        interfaceName = &quot;javax.jms.Queue&quot;
)
@MessageDriven(activationConfig = {
    @ActivationConfigProperty(propertyName = &quot;destinationLookup&quot;, propertyValue = DuplicateJMSTestBean.DUPLICATE_QUEUE),
    @ActivationConfigProperty(propertyName = &quot;destinationType&quot;, propertyValue = &quot;javax.jms.Queue&quot;)
})
@TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)
public class DuplicateJMSTestBean implements MessageListener {

    public final static String DUPLICATE_QUEUE = &quot;java:global/jms/duplicateTestQueue&quot;;

    @Override
    public void onMessage(Message msg) {
        System.out.println(&quot;Got new message.&quot;);
        MessageStorage.messages.add(msg);
        try {
            Thread.sleep(5_000l);
        } catch(Exception ignore) {}
        System.out.println(&quot;Message  successfully processed&quot;);
    }
}
</code></pre>
<p>And simple JAX-RS endpoint to produce messages</p>
<pre><code class="language-java">@Path(&quot;/&quot;)
@Stateless
@TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)
public class DuplicateTestEndpoint {

    @Inject
    private JMSContext context;
    @Resource(lookup = DuplicateJMSTestBean.DUPLICATE_QUEUE)
    private Queue queue;

    @GET
    @Path(&quot;/sendmessage&quot;)
    public Response sendMessage(@QueryParam(&quot;duplicate-id&quot;) String duplicateId) {
        try {
            ObjectMessage message = context.createObjectMessage();
            if (duplicateId == null) {
                context.createProducer().send(queue, message);
            } else {
                message.setStringProperty(&quot;_AMQ_DUPL_ID&quot;, duplicateId);
                context.createProducer().send(queue, message);
            }
            return Response.ok().entity(&quot;Message was sent.  Recieved &quot; + MessageStorage.messages.size() + &quot; messagges: &quot; + MessageStorage.messages).build();
        } catch (Throwable e) {
            return Response.ok().entity(&quot;Error: &quot; + e).build();
        }
    }
}
</code></pre>
<p>Now in case we send message with the same <code>_AMQ_DUPL_ID</code> without transaction by <code>http://127.0.0.1:8080/jms-examples/sendmessage?duplicate-id=myuniqueid</code> we will get in logs:</p>
<pre><code class="language-java">WARN [org.apache.activemq.artemis.core.server] (Thread-448 (ActiveMQ-server-org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl$5@e47887a)) AMQ222059: Duplicate message detected - message will not be routed. Message information:
CoreMessage[messageID=1505,durable=true,userID=3d27afde-a9fa-11e9-af5d-0242e352ec80,priority=4, timestamp=Fri Jul 19 10:53:04 EEST 2019,expiration=0, durable=true, address=jms.queue.jms-examples_jms-examples_jms-examples_java:global/jms/duplicateTestQueue,size=416,properties=TypedProperties[__AMQ_CID=38587489-a9fa-11e9-af5d-0242e352ec80,_AMQ_DUPL_ID=myuniqueid,_AMQ_ROUTING_TYPE=1]]@145077408
</code></pre>
<p>and message will NOT consume by consumer. In case you send message in transaction - you will get <code>Exception</code> on commit.</p>
<p>Keep in mind, that to store IDs activemq uses circular fixed size cache</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default:read-attribute(name=id-cache-size)
{
    &quot;outcome&quot; =&gt; &quot;success&quot;,
    &quot;result&quot; =&gt; 20000
}
</code></pre>
<p>so, this value should be big enough to avoid rewriting. Also, you can configure persist cache or not (by default: <code>true</code>)</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default:write-attribute(name=persist-id-cache,value=false)
</code></pre>
<p>Source code available on <a href="https://github.com/kostenkoserg/ee-jms-examples">GitHub</a></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/07/wildfly-jms-duplicate-detection.html#disqus_thread" data-disqus-identifier="blog/2019/07/wildfly-jms-duplicate-detection.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/07/jenkins-nice-to-have-plugins.html"><h1>Jenkins. Nice to have plugins</h1></a>
				<p>05 July 2019</p>
  			<p><p>Jenkins is leading open source automation tool that provides lot of plugins to make your CI better. Below is few of them that, on my opinion, can be helpful for any project.</p>
<blockquote>
<p><strong>1. <a href="https://plugins.jenkins.io/build-monitor-plugin">Build Monitor Plugin</a></strong> - provides a highly visible view of the status of selected Jenkins jobs;</p>
</blockquote>
<p><img src="/img/2019-07-jenkins-build-monitor-plugin.png" alt="Build Monitor Plugin" /></p>
<blockquote>
<p><strong>2. <a href="https://plugins.jenkins.io/git-parameter">Git Parameter Plugin</a></strong> - adds ability to choose branches, tags or revisions from git repository configured in project;</p>
</blockquote>
<p><img src="/img/2019-07-jenkins-git-parameter-plugin.png" alt="Git Parameter Plugin" /></p>
<blockquote>
<p><strong>3. <a href="https://plugins.jenkins.io/htmlpublisher">HTML Publisher Plugin</a></strong> - publish the html reports that your build generates to the job and build pages;</p>
</blockquote>
<p><img src="/img/2019-07-jenkins-html-report-plugin.png" alt="Git Parameter Plugin" /></p>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/07/jenkins-nice-to-have-plugins.html#disqus_thread" data-disqus-identifier="blog/2019/07/jenkins-nice-to-have-plugins.html">Comments</a></p>
				<hr/>
				<a href="https://kostenko.org/blog/2019/06/wildfly-activemq-deadlock.html"><h1>Wildfly active-mq subsystem deadlock</h1></a>
				<p>29 June 2019</p>
  			<p><p>Recently got unusual height CPU utilizaton on random wildly cluster instance. Thread dump shows the reason of a problem:</p>
<pre><code class="language-java">Found one Java-level deadlock:
=============================

&quot;Thread-1 (ActiveMQ-server-org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl$2@46fcd20a-1114701218)&quot;:
  waiting to lock Monitor@0x00007f45f02e20f8 (Object@0x0000000603407950, a org/apache/activemq/artemis/core/server/cluster/impl/ClusterConnectionImpl$MessageFlowRecordImpl),
  which is held by &quot;Thread-29 (ActiveMQ-client-global-threads-2129186403)&quot;
&quot;Thread-29 (ActiveMQ-client-global-threads-2129186403)&quot;:
  waiting to lock Monitor@0x00007f46203b5518 (Object@0x00000004cc79a7b8, a org/apache/activemq/artemis/core/server/impl/QueueImpl),
  which is held by &quot;Thread-1 (ActiveMQ-server-org.apache.activemq.artemis.core.server.impl.ActiveMQServerImpl$2@46fcd20a-1114701218)&quot;

Found a total of 1 deadlock.
</code></pre>
<p>Below is part of official documentation:</p>
<blockquote>
<p>&quot;If thread-pool-max-size is set to a positive integer greater than zero, the thread pool is bounded. If requests come in and there are no free threads available in the pool, requests will block until a thread becomes available. It is recommended that a bounded thread pool be used with caution since it can lead to <strong>deadlock situations</strong> if the upper bound is configured too low.&quot;</p>
</blockquote>
<p>So, solution is:</p>
<pre><code class="language-java">/subsystem=messaging-activemq/server=default:write-attribute(name=thread-pool-max-size,value=-1)
</code></pre>
</p>
				<p class="text-right"><a href="https://kostenko.org/blog/2019/06/wildfly-activemq-deadlock.html#disqus_thread" data-disqus-identifier="blog/2019/06/wildfly-activemq-deadlock.html">Comments</a></p>
				<hr/>

		<ul class="pager">
				<li class="previous"><a href="https://kostenko.org/2">Previous</a></li>
			<li">Page: 3/7 (<a href="../archive.html">archive</a>)</li>
				<li class="next"><a href="https://kostenko.org/4">Next</a></li>
		</ul>
		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2019 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.6.3</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <!--script src="../js/prettify.js"></script-->
		<script src="../js/prism.js"></script>

		<script id="dsq-count-scr" src="//kostenko-org.disqus.com/count.js" async></script>
  </body>
</html>
