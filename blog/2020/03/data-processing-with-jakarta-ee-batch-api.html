<!DOCTYPE html>
<html lang="en">
  <head>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132824591-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-132824591-1');
</script>

    <meta charset="utf-8"/>
    <title>Load huge amount of data with Jakarta EE Batch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keywords" content="">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../../../css/bootstrap.min.css" rel="stylesheet">
    <link href="../../../css/asciidoctor.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <!--link href="../../../css/prettify.css" rel="stylesheet"-->
    <link href="../../../css/prism.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" href="../../../favicon.ico">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <b><a class="navbar-brand" href="../../../index.html">Sergii Kostenko's Blog</a></b>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../../../about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
										<li><a href="../../../tags/wildfly.html">wildfly</a></li>
										<li><a href="../../../tags/logging.html">logging</a></li>
										<li><a href="../../../tags/jakartaee.html">jakartaee</a></li>
										<li><a href="../../../tags/resin.html">resin</a></li>
										<li><a href="../../../tags/performance.html">performance</a></li>
										<li><a href="../../../tags/infinispan.html">infinispan</a></li>
										<li><a href="../../../tags/gradle.html">gradle</a></li>
										<li><a href="../../../tags/ide.html">ide</a></li>
										<li><a href="../../../tags/cdi.html">cdi</a></li>
										<li><a href="../../../tags/batch.html">batch</a></li>
										<li><a href="../../../tags/ci.html">ci</a></li>
										<li><a href="../../../tags/openapi.html">openapi</a></li>
										<li><a href="../../../tags/microprofile.html">microprofile</a></li>
										<li><a href="../../../tags/jberet.html">jberet</a></li>
										<li><a href="../../../tags/github.html">github</a></li>
										<li><a href="../../../tags/activemq.html">activemq</a></li>
										<li><a href="../../../tags/jetty.html">jetty</a></li>
										<li><a href="../../../tags/api.html">api</a></li>
										<li><a href="../../../tags/jcache.html">jcache</a></li>
										<li><a href="../../../tags/jpa.html">jpa</a></li>
										<li><a href="../../../tags/jenkins.html">jenkins</a></li>
										<li><a href="../../../tags/json-b.html">json-b</a></li>
										<li><a href="../../../tags/linux.html">linux</a></li>
										<li><a href="../../../tags/jmx.html">jmx</a></li>
										<li><a href="../../../tags/vaadin.html">vaadin</a></li>
										<li><a href="../../../tags/java.html">java</a></li>
										<li><a href="../../../tags/security.html">security</a></li>
										<li><a href="../../../tags/jms.html">jms</a></li>
										<li><a href="../../../tags/jaxb.html">jaxb</a></li>
										<li><a href="../../../tags/sql.html">sql</a></li>
										<li><a href="../../../tags/swagger.html">swagger</a></li>
										<li><a href="../../../tags/hibernate.html">hibernate</a></li>
										<li><a href="../../../tags/quarkus.html">quarkus</a></li>
										<li><a href="../../../tags/jwt.html">jwt</a></li>
										<li><a href="../../../tags/rest-client.html">rest-client</a></li>
										<li><a href="../../../tags/tomcat.html">tomcat</a></li>
										<li><a href="../../../tags/jax-rs.html">jax-rs</a></li>
										<li><a href="../../../tags/jsr532.html">jsr532</a></li>
										<li><a href="../../../tags/jbake.html">jbake</a></li>
								</ul>
						</li>
          </ul>
					<!-- switch language -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="/">en</a></li>
						<li><a href="/ru">ru</a></li>
						<li><a  class="icon-rss" href="../../../feed.xml"></a></li>
					</ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">

	<div class="page-header">
		<h1>Load huge amount of data with Jakarta EE Batch</h1>
	</div>

	<p><em>25 March 2020</em></p>

	<p><p>Processing huge amount of data is a challenge for every enterprise system. Jakarta EE specifications provides useful approach to get it done through <strong><a href="https://projects.eclipse.org/projects/ee4j.batch">Jakarta Batch</a></strong> (JSR-352):</p>
<blockquote>
<p>Batch processing is a pervasive workload pattern, expressed by a distinct application organization and execution model. It is found across virtually every industry, applied to such tasks as statement generation, bank postings, risk evaluation, credit score calculation, inventory management, portfolio optimization, and on and on. Nearly any bulk processing task from any business sector is a candidate for batch processing.<br />
Batch processing is typified by bulk-oriented, non-interactive, background execution. Frequently long-running, it may be data or computationally intensive, execute sequentially or in parallel, and may be initiated through various invocation models, including ad hoc, scheduled, and on-demand.<br />
Batch applications have common requirements, including logging, checkpointing, and parallelization. Batch workloads have common requirements, especially operational control, which allow for initiation of, and interaction with, batch instances; such interactions include stop and restart.</p>
</blockquote>
<p>One of the typical use case is a import data from different sources and formats to internal database. Below we will design sample application to import data, for example, from  <code>json</code> and <code>xml</code> files to the database and see how well structured it can be.</p>
<p>Using <strong>Eclipse Red Hat CodeReady Studio plugin</strong>, we can easily design our solution diagram:<br />
<img src="/img/2020-02-jakarta-batch-import.png" alt="import batch diagram" /></p>
<p>Jakarta Batch descriptor in this case will looks like:<br />
<code>META-INF/batch-jobs/hugeImport.xml:</code></p>
<pre><code class="language-java">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;job id=&quot;hugeImport&quot; xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/jobXML_1_0.xsd&quot; version=&quot;1.0&quot;&gt;
    &lt;step id=&quot;fileSelector&quot; next=&quot;decider&quot;&gt;
        &lt;batchlet ref=&quot;fileSelectorBatchlet&quot;&gt;
            &lt;properties&gt;
                &lt;property name=&quot;path&quot; value=&quot;/tmp/files2import&quot;/&gt;
            &lt;/properties&gt;
        &lt;/batchlet&gt;
    &lt;/step&gt;
    &lt;decision id=&quot;decider&quot; ref=&quot;myDecider&quot;&gt;
        &lt;next on=&quot;xml&quot; to=&quot;xmlParser&quot;/&gt;
        &lt;next on=&quot;json&quot; to=&quot;jsonParser&quot;/&gt;
    &lt;/decision&gt;
    &lt;step id=&quot;xmlParser&quot; next=&quot;chunkProcessor&quot;&gt;
        &lt;batchlet ref=&quot;xmlParserBatchlet&quot;/&gt;
    &lt;/step&gt;
    &lt;step id=&quot;jsonParser&quot; next=&quot;chunkProcessor&quot;&gt;
        &lt;batchlet ref=&quot;jsonParserBatchlet&quot;/&gt;
    &lt;/step&gt;
    &lt;step id=&quot;chunkProcessor&quot;&gt;
        &lt;chunk&gt;
            &lt;reader ref=&quot;itemReader&quot;/&gt;
            &lt;processor ref=&quot;itemMockProcessor&quot;/&gt;
            &lt;writer ref=&quot;itemJpaWriter&quot;/&gt;
        &lt;/chunk&gt;
        &lt;partition&gt;
            &lt;plan partitions=&quot;5&quot;&gt;&lt;/plan&gt;
        &lt;/partition&gt;
    &lt;/step&gt;
&lt;/job&gt;
</code></pre>
<p>So, now we need to implement each brick above and try to keep each batchlet independent as much as possible. As you can see from above our sample job consist from:</p>
<ul>
<li><strong>fileSelector</strong> - batchlet do file selection based on supported by configuration file extension</li>
<li><strong>decider</strong> - decision maker, responsible for choosing right parser</li>
<li><strong>xml\jsonParser</strong> - parser batchlets, responsible for file parsing to a list of items</li>
<li><strong>chunkProcessor</strong> - items processing chunk(<strong>reader</strong>, optional <strong>processor</strong> and <strong>writer</strong>) with partitioning to boost performance</li>
</ul>
<p>Before start with implementation, let's design useful solution to <strong>share state between steps</strong>. Unfortunately, Jakarta Batch Specification does not provide job scoped CDI beans yet (JBeret implementation does, specification doesn't). But we able to use <strong><code>JobContext.set\getTransientUserData()</code></strong> to deal with the current batch context. In our case we want to share <code>File</code> and <code>Queue</code> with  items for processing:</p>
<pre><code class="language-java">@Named
public class ImportJobContext {
    @Inject
    private JobContext jobContext;

    private Optional&lt;File&gt; file = Optional.empty();
    private Queue&lt;ImportItem&gt; items = new ConcurrentLinkedQueue&lt;&gt;();

    public Optional&lt;File&gt; getFile() {
        return getImportJobContext().file;
    }
    public void setFile(Optional&lt;File&gt; file) {
        getImportJobContext().file = file;
    }
    public Queue&lt;ImportItem&gt; getItems() {
        return getImportJobContext().items;
    }

    private ImportJobContext getImportJobContext() {
        if (jobContext.getTransientUserData() == null) {
            jobContext.setTransientUserData(this);
        }
        return (ImportJobContext) jobContext.getTransientUserData();
    }
}
</code></pre>
<p>Now we can inject our custom <strong><code>ImportJobContext</code></strong> to share type-safe state between batchlets. First step is search file for processing by provided in step properties path:</p>
<pre><code class="language-java">@Named
public class FileSelectorBatchlet extends AbstractBatchlet {

    @Inject
    private ImportJobContext jobContext;

    @Inject
    @BatchProperty
    private String path;

    @Override
    public String process() throws Exception {
        Optional&lt;File&gt; file = Files.walk(Paths.get(path)).filter(Files::isRegularFile).map(Path::toFile).findAny();
        if (file.isPresent()) {
            jobContext.setFile(file);
        }
        return BatchStatus.COMPLETED.name();
    }
}
</code></pre>
<p>After we need to make decision about parser, for example, based on extension. Decider just returns file extension as string and then  <strong>batch runtime</strong>  should give control to the corresponding parser batchlet. Please, check <code>&lt;decision id=&quot;decider&quot; ref=&quot;myDecider&quot;&gt;</code> section in the XML batch descriptor above.</p>
<pre><code class="language-java">@Named
public class MyDecider implements Decider {

    @Inject
    private ImportJobContext jobContext;

    @Override
    public String decide(StepExecution[] ses) throws Exception {
        if (!jobContext.getFile().isPresent()) {
            throw new FileNotFoundException();
        }
        String name = jobContext.getFile().get().getName();
        String extension = name.substring(name.lastIndexOf(&quot;.&quot;)+1);
        return extension;
    }
}
</code></pre>
<p>ParserBatchlet in turn should parse file using <strong>JSON-B</strong> or <strong>JAXB</strong> depends on type and fill Queue with <strong><code>ImportItem</code></strong> objects. I would like to use <strong><code>ConcurrentLinkedQueue</code></strong> to share items between partitions, but if you need for some other behavior here, you can provide <strong><code>javax.batch.api.partition.PartitionMapper</code></strong> with your own implementation</p>
<pre><code class="language-java">@Named
public class JsonParserBatchlet  extends AbstractBatchlet {

    @Inject
    ImportJobContext importJobContext;

    @Override
    public String process() throws Exception {

        List&lt;ImportItem&gt; items = JsonbBuilder.create().fromJson(
                new FileInputStream(importJobContext.getFile().get()),
                new ArrayList&lt;ImportItem&gt;(){}.getClass().getGenericSuperclass());

        importJobContext.getItems().addAll(items);
        return BatchStatus.COMPLETED.name();
    }
}
</code></pre>
<p>ItemReader then will looks as simple as possible, just pool item from the Queue:</p>
<pre><code class="language-java">@Named
public class ItemReader  extends AbstractItemReader {

    @Inject
    ImportJobContext importJobContext;

    @Override
    public ImportItem readItem() throws Exception {

        return importJobContext.getItems().poll();
    }
}
</code></pre>
<p>And persist time...</p>
<pre><code class="language-java">@Named
public class ItemJpaWriter  extends AbstractItemWriter  {

    @PersistenceContext
    EntityManager entityManager;

    @Override
    public void writeItems(List&lt;Object&gt; list) throws Exception {
        for (Object obj : list) {
            ImportItem item = (ImportItem) obj;
            entityManager.merge(item);
        }
    }
}
</code></pre>
<p>Actually, this is it! Now we able to easily extend our application with new parsers, processors and writers without any existing code changes,  - just describe new (update existing) flows over Jakarta Batch descriptor.<br />
Of course, <strong>Jakarta Batch specification</strong> provides much more helpful functionality than i have covered in this post (<strong>Checkpoints</strong>, <strong>Exception Handling</strong>, <strong>Listeners</strong>, <strong>Flow Control</strong>, <strong>Failed job restarting</strong> etc.), but even it enough to see how simple, power and well structured it can be.</p>
<p><strong>Note!</strong> <strong>Wildfly Application Server</strong> implements Jakarta Batch specification through the <strong>batch-jberet subsystem</strong>. By default last one configured to use only <strong>10</strong> threads.</p>
<pre><code class="language-xml">&lt;subsystem xmlns=&quot;urn:jboss:domain:batch-jberet:2.0&quot;&gt;
    ...
    &lt;thread-pool name=&quot;batch&quot;&gt;
        &lt;max-threads count=&quot;10&quot;/&gt;
        &lt;keepalive-time time=&quot;30&quot; unit=&quot;seconds&quot;/&gt;
    &lt;/thread-pool&gt;
&lt;/subsystem&gt;
</code></pre>
<p>So, if you are planing intensive usage of <strong>Batch runtime</strong> - feel free to increase this parameter:</p>
<pre><code class="language-bash">/subsystem=batch-jberet/thread-pool=batch/:write-attribute(name=max-threads, value=100)
</code></pre>
<p>Described sample application source code available on <a href="https://github.com/kostenkoserg/ee-batch-processing-examples">GitHub</a></p>
</p>

	<hr />
	<div class="row">
	<div class="box">

	<div id="disqus_thread"></div>
	<script>

	var disqus_config = function () {
	this.page.url = 'https://kostenko.org/blog/2020/03/data-processing-with-jakarta-ee-batch-api.html';
	this.page.identifier = 'blog/2020/03/data-processing-with-jakarta-ee-batch-api.html';
	};

	(function() { // DON'T EDIT BELOW THIS LINE
		var d = document, s = d.createElement('script');
		s.src = 'https://kostenko-org.disqus.com/embed.js';
		s.setAttribute('data-timestamp', +new Date());
		(d.head || d.body).appendChild(s);
	})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
</div>

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="muted credit">&copy; 2019 | Mixed with <a href="http://getbootstrap.com/">Bootstrap v3.1.1</a> | Baked with <a href="http://jbake.org">JBake v2.6.4</a></p>
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../../js/jquery-1.11.1.min.js"></script>
    <script src="../../../js/bootstrap.min.js"></script>
    <!--script src="../../../js/prettify.js"></script-->
		<script src="../../../js/prism.js"></script>

		<script id="dsq-count-scr" src="//kostenko-org.disqus.com/count.js" async></script>
  </body>
</html>
